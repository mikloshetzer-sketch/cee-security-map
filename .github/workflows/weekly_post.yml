name: Weekly WordPress Post (CEE)

on:
  schedule:
    - cron: "0 7 * * MON"
  workflow_dispatch:

jobs:
  post:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests

      # Fetch a fresh access token using refresh_token
      - name: Refresh WordPress.com access token (CEE)
        env:
          CLIENT_ID: ${{ secrets.WPCOM_CEE_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.WPCOM_CEE_CLIENT_SECRET }}
          REFRESH_TOKEN: ${{ secrets.WPCOM_CEE_REFRESH_TOKEN }}
        run: |
          set -euo pipefail

          python - <<'PY'
          import os, json, sys
          import requests

          token_url = "https://public-api.wordpress.com/oauth2/token"

          client_id = os.environ.get("CLIENT_ID","").strip()
          client_secret = os.environ.get("CLIENT_SECRET","").strip()
          refresh_token = os.environ.get("REFRESH_TOKEN","").strip()

          if not client_id or not client_secret or not refresh_token:
            print("[ERROR] Missing one of: WPCOM_CEE_CLIENT_ID / WPCOM_CEE_CLIENT_SECRET / WPCOM_CEE_REFRESH_TOKEN", file=sys.stderr)
            sys.exit(2)

          data = {
            "client_id": client_id,
            "client_secret": client_secret,
            "grant_type": "refresh_token",
            "refresh_token": refresh_token,
          }

          r = requests.post(token_url, data=data, timeout=30)
          try:
            payload = r.json()
          except Exception:
            print(f"[ERROR] Non-JSON response: {r.status_code} {r.text[:200]}", file=sys.stderr)
            sys.exit(1)

          if r.status_code >= 400 or "error" in payload:
            print("[ERROR] Token refresh failed:", json.dumps(payload, indent=2, ensure_ascii=False), file=sys.stderr)
            sys.exit(1)

          access_token = payload.get("access_token")
          if not access_token:
            print("[ERROR] No access_token in refresh response", file=sys.stderr)
            sys.exit(1)

          # Export access token for subsequent steps (do NOT print it)
          gh_env = os.environ["GITHUB_ENV"]
          with open(gh_env, "a", encoding="utf-8") as f:
            f.write(f"WPCOM_ACCESS_TOKEN={access_token}\n")

          print("[OK] Refreshed access token (not printed).")
          PY

      - name: Publish weekly post
        env:
          # This now comes from the previous step via GITHUB_ENV
          WPCOM_ACCESS_TOKEN: ${{ env.WPCOM_ACCESS_TOKEN }}
        run: |
          set -euo pipefail
          python scripts/post_weekly_wordpress.py
