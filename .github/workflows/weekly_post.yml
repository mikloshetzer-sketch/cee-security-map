name: Weekly WordPress Post

on:
  schedule:
    - cron: "0 7 * * MON"
  workflow_dispatch:

jobs:
  post:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      # ---- TOKEN SANITY CHECK (nem írja ki a tokent) ----
      - name: Token sanity (safe)
        env:
          WPCOM_ACCESS_TOKEN: ${{ secrets.WPCOM_ACCESS_TOKEN }}
        run: |
          python - <<'PY'
          import os, hashlib
          t = os.getenv("WPCOM_ACCESS_TOKEN","")
          print("token_len =", len(t))
          print("token_strip_len =", len(t.strip()))
          print("token_sha256 =", hashlib.sha256(t.encode("utf-8")).hexdigest())
          PY

      # ---- TOKEN VALIDÁCIÓ A WORDPRESS.COM FELÉ ----
      - name: Verify WordPress.com token (safe)
        env:
          WPCOM_ACCESS_TOKEN: ${{ secrets.WPCOM_ACCESS_TOKEN }}
        run: |
          set -euo pipefail
          curl -sS -H "Authorization: Bearer ${WPCOM_ACCESS_TOKEN}" \
            "https://public-api.wordpress.com/oauth2/token-info" | python -m json.tool

      # ---- HETI POSZT ----
      - name: Publish weekly post
        env:
          WPCOM_ACCESS_TOKEN: ${{ secrets.WPCOM_ACCESS_TOKEN }}
          WPCOM_SITE: ${{ secrets.WPCOM_SITE }}
        run: |
          set -euo pipefail
          python scripts/post_weekly_wordpress.py
