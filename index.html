<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Közép–Kelet Európa Biztonsági Monitor</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body { margin:0; font-family: system-ui, Arial; }
    #map { height: 100vh; width: 100vw; }
    .panel {
      position:absolute;
      top:10px;
      left:10px;
      z-index:1000;
      background:white;
      padding:12px;
      border-radius:12px;
      box-shadow:0 8px 28px rgba(0,0,0,0.15);
      max-width:340px;
      font-size:13px;
    }
    .panel h3 { margin:0 0 6px 0; }
    .panel ul { margin:6px 0 0 16px; padding:0; }
  </style>
</head>

<body>

<div id="map"></div>

<div class="panel">
  <h3>Napi kivonat</h3>
  <div id="daily"></div>

  <h3 style="margin-top:12px;">Heti kivonat</h3>
  <div id="weekly"></div>
</div>

<script>

const cacheBuster = "?v=" + Date.now();

// MAP
const map = L.map('map').setView([52, 19], 5);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 18,
  attribution: '&copy; OpenStreetMap'
}).addTo(map);

// ----- EVENT STYLE (7 napos színezés)
function eventStyle(props) {
  const now = new Date();
  const d = new Date(props.time);
  const age = (now - d) / (1000*60*60*24);

  if (age <= 1) return { color:"#b91c1c", fillColor:"#ef4444", radius:8 };
  if (age <= 3) return { color:"#c2410c", fillColor:"#f97316", radius:7 };
  if (age <= 7) return { color:"#a16207", fillColor:"#f59e0b", radius:6 };
  return { color:"#6b7280", fillColor:"#9ca3af", radius:5 };
}

// ----- LOAD GEOJSON
async function loadLayer(url, name) {
  const r = await fetch(url + cacheBuster);
  const gj = await r.json();

  return L.geoJSON(gj, {
    pointToLayer: (feature, latlng) => {
      const s = eventStyle(feature.properties || {});
      return L.circleMarker(latlng, {
        radius: s.radius,
        color: s.color,
        fillColor: s.fillColor,
        fillOpacity: 0.35,
        weight:1
      });
    },
    onEachFeature: (feature, layer) => {
      const p = feature.properties || {};
      layer.bindPopup(`
        <b>${p.title || ""}</b><br>
        ${p.place || ""}<br>
        ${p.time || ""}
      `);
    }
  });
}

// ----- HOTSPOTS
async function loadHotspots() {
  const r = await fetch("./data/hotspots.geojson" + cacheBuster);
  const gj = await r.json();

  return L.geoJSON(gj, {
    pointToLayer: (feature, latlng) => {
      const s = feature.properties.score || 0;
      return L.circleMarker(latlng, {
        radius: 6 + s*4,
        color:"#2563eb",
        fillColor:"#60a5fa",
        fillOpacity:0.3,
        weight:1
      });
    }
  });
}

// ----- SUMMARY
async function loadSummary() {
  const d = await (await fetch("./data/summary.json" + cacheBuster)).json();
  document.getElementById("daily").innerHTML =
    "<ul>" + (d.bullets||[]).map(x=>"<li>"+x+"</li>").join("") + "</ul>";
}

// ----- WEEKLY
async function loadWeekly() {
  const w = await (await fetch("./data/weekly.json" + cacheBuster)).json();
  document.getElementById("weekly").innerHTML =
    "<ul>" + (w.bullets||[]).map(x=>"<li>"+x+"</li>").join("") + "</ul>";
}

// ----- BORDERS
async function loadBorders() {
  const r = await fetch("./data/balkan_borders.geojson" + cacheBuster);
  const gj = await r.json();
  return L.geoJSON(gj, {
    style: () => ({ color:"#2563eb", weight:1.2, fillOpacity:0 })
  });
}

// INIT
(async function(){

  const borders = await loadBorders();
  borders.addTo(map);

  const gdelt = await loadLayer("./data/gdelt.geojson", "GDELT");
  const usgs = await loadLayer("./data/usgs.geojson", "USGS");
  const gdacs = await loadLayer("./data/gdacs.geojson", "GDACS");
  const hot = await loadHotspots();

  gdelt.addTo(map);
  usgs.addTo(map);
  hot.addTo(map);

  loadSummary();
  loadWeekly();

})();

</script>

</body>
</html>
