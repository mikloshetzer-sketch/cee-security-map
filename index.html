<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Közép–Kelet Európa Biztonsági Monitor</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100vh; width: 100vw; }
    .panel { position:absolute; top:12px; left:12px; width:min(520px, calc(100vw - 24px));
      max-height:calc(100vh - 24px); overflow:auto; background:rgba(255,255,255,0.95);
      border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.15); padding:12px; z-index:9999;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    .panel.hidden{display:none}
    .panel-right{ position:absolute; top:12px; right:12px; width:min(360px, calc(100vw - 24px));
      max-height:calc(100vh - 24px); overflow:auto; background:rgba(255,255,255,0.95);
      border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.15); padding:10px; z-index:9999;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    .panel-right.hidden{display:none}
    .row{display:flex; gap:8px; align-items:center;}
    .grow{flex:1}
    button{border:1px solid rgba(0,0,0,0.15); background:white; border-radius:10px; padding:6px 10px; cursor:pointer; font-size:12px;}
    button:hover{background:#f3f4f6}
    .meta{font-size:12px; color:#555; margin-bottom:10px;}
    .section{border-top:1px solid rgba(0,0,0,0.08); padding-top:10px; margin-top:10px;}
    .section h3{margin:0 0 6px 0; font-size:14px;}
    ul{margin:6px 0 0 18px; padding:0;}
    li{margin:4px 0; font-size:13px;}
    .floating-btn{position:absolute; z-index:9999; border:1px solid rgba(0,0,0,0.15);
      background:rgba(255,255,255,0.95); border-radius:999px; padding:8px 12px; font-size:12px;
      box-shadow:0 8px 20px rgba(0,0,0,0.12); cursor:pointer; display:none;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    #openPanelBtn{top:12px; left:12px;}
    #openLayersBtn{top:12px; right:12px;}
    #openHotspotsBtn{bottom:12px; left:12px;}

    .popup-title{font-weight:700; font-size:13px; margin-bottom:6px;}
    .popup-meta{font-size:12px; color:#444; margin:2px 0;}
    .badge{display:inline-block; font-size:11px; padding:2px 8px; border-radius:999px; background:#eef2ff; color:#1f2a72; margin-right:6px; margin-bottom:6px;}
    .cat-protest{background:#dcfce7; color:#14532d;}
    .cat-military{background:#fee2e2; color:#7f1d1d;}
    .cat-police{background:#e0f2fe; color:#0c4a6e;}
    .cat-security{background:#ffe4e6; color:#881337;}
    .cat-disaster{background:#e5e7eb; color:#111827;}
    .cat-other{background:#eef2ff; color:#1f2a72;}
  </style>
</head>
<body>
  <div id="map"></div>

  <div id="mainPanel" class="panel">
    <div class="row">
      <div class="grow">
        <h2 style="margin:4px 0 6px 0; font-size:16px;">Közép–Kelet Európa Biztonsági Monitor – helyzetkép</h2>
        <div id="metaLine" class="meta">Frissítés: —</div>
      </div>
      <button id="closeMainPanel">Bezár</button>
    </div>

    <div class="section">
      <h3>Napi kivonat</h3>
      <ul id="dailyBullets"></ul>
    </div>

    <div class="section">
      <h3>Heti kivonat (7 nap)</h3>
      <ul id="weeklyBullets"></ul>
    </div>

    <div class="section">
      <h3>Early signals (elemző mód)</h3>
      <div id="earlyHint" class="meta">—</div>
    </div>
  </div>

  <div id="layersPanel" class="panel-right">
    <div class="row">
      <div class="grow"><h3 style="margin:4px 0 8px 0; font-size:14px;">Rétegek</h3></div>
      <button id="closeLayersPanel">Bezár</button>
    </div>
    <div id="layersList" class="meta">Betöltés…</div>
  </div>

  <div id="hotspotsPanel" class="panel-right" style="left:12px; right:auto; top:auto; bottom:12px; width:min(520px, calc(100vw - 24px));">
    <div class="row">
      <div class="grow"><h3 style="margin:4px 0 8px 0; font-size:14px;">Top hotspotok</h3></div>
      <button id="closeHotspotsPanel">Bezár</button>
    </div>
    <div id="hotspotsList" class="meta">—</div>
  </div>

  <button id="openPanelBtn" class="floating-btn">Kinyit</button>
  <button id="openLayersBtn" class="floating-btn">Rétegek</button>
  <button id="openHotspotsBtn" class="floating-btn">Top hotspotok</button>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const esc = (s) => String(s ?? "").replace(/[&<>"']/g, (m) => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
    const fmtTime = (iso) => {
      if (!iso) return "—";
      try { return new Date(iso).toLocaleString("hu-HU", { year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" }); }
      catch { return iso; }
    };

    const catLabelHU = (cat) => ({
      "protest":"tüntetés/szociális",
      "military":"katonai",
      "police":"rendőrségi/igazságügy",
      "security":"erőszak/biztonsági incidens",
      "disaster":"katasztrófa/természeti",
      "other":"egyéb"
    }[cat] || cat || "—");

    const catClass = (cat) => "badge cat-" + (cat || "other").toLowerCase();

    const map = L.map("map").setView([47.3, 19.1], 5);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 18, attribution: "&copy; OpenStreetMap" }).addTo(map);

    const layerBorders = L.geoJSON(null, { style: { color: "#1d4ed8", weight: 2, fillOpacity: 0 } });
    const layerHotspots = L.geoJSON(null, { pointToLayer:(f,latlng)=>L.circleMarker(latlng,{radius:9,color:"#111827",weight:1,fillColor:"#60a5fa",fillOpacity:0.35})});
    const layerEarly = L.geoJSON(null, { pointToLayer:(f,latlng)=>L.circleMarker(latlng,{radius:8,color:"#111827",weight:1,fillColor:"#f59e0b",fillOpacity:0.35})});

    const layerGDELT = L.geoJSON(null, {
      pointToLayer:(f,latlng)=>L.circleMarker(latlng,{radius:6,color:"#ef4444",weight:1,fillColor:"#ef4444",fillOpacity:0.35}),
      onEachFeature:(f,layer)=>{
        const p=f.properties||{};
        const title=p.title||p.location||"Esemény";
        const url=p.url||null;
        const cat=(p.category||"other").toLowerCase();
        const linkHtml = url ? `<a href="${esc(url)}" target="_blank" rel="noopener noreferrer">Forrás megnyitása</a>` : `Nincs link az adatban`;
        layer.bindPopup(`
          <div class="popup-title">${url ? `<a href="${esc(url)}" target="_blank" rel="noopener noreferrer">${esc(title)}</a>` : esc(title)}</div>
          <div class="${catClass(cat)}">${esc(catLabelHU(cat))}</div>
          <div class="popup-meta"><b>Idő:</b> ${esc(fmtTime(p.time))}</div>
          <div class="popup-meta"><b>Hely:</b> ${esc(p.location || "—")}</div>
          <div class="popup-meta"><b>GDELT ID:</b> ${esc(p.gdelt_id || "—")}</div>
          <div class="popup-meta">${linkHtml}</div>
        `,{maxWidth:420});
      }
    });

    const layerUSGS = L.geoJSON(null, { pointToLayer:(f,latlng)=>L.circleMarker(latlng,{radius:7,color:"#111827",weight:1,fillColor:"#6b7280",fillOpacity:0.35}),
      onEachFeature:(f,layer)=>{ const p=f.properties||{};
        layer.bindPopup(`<div class="popup-title">${p.url?`<a href="${esc(p.url)}" target="_blank" rel="noopener noreferrer">${esc(p.title||"Earthquake")}</a>`:esc(p.title||"Earthquake")}</div>
          <div class="badge cat-disaster">katasztrófa/természeti</div>
          <div class="popup-meta"><b>Idő:</b> ${esc(fmtTime(p.time))}</div>`); }
    });

    const layerGDACS = L.geoJSON(null, { pointToLayer:(f,latlng)=>L.circleMarker(latlng,{radius:7,color:"#111827",weight:1,fillColor:"#9ca3af",fillOpacity:0.35}),
      onEachFeature:(f,layer)=>{ const p=f.properties||{};
        layer.bindPopup(`<div class="popup-title">${p.url?`<a href="${esc(p.url)}" target="_blank" rel="noopener noreferrer">${esc(p.title||"GDACS Alert")}</a>`:esc(p.title||"GDACS Alert")}</div>
          <div class="badge cat-disaster">katasztrófa/természeti</div>
          <div class="popup-meta"><b>Idő:</b> ${esc(fmtTime(p.time))}</div>`); }
    });

    async function fetchJSON(path){
      const r=await fetch(path,{cache:"no-store"});
      if(!r.ok) throw new Error(path+" "+r.status);
      return await r.json();
    }

    function setBullets(id, bullets){
      const ul=document.getElementById(id); ul.innerHTML="";
      (bullets||[]).forEach(b=>{ const li=document.createElement("li"); li.textContent=b; ul.appendChild(li); });
    }

    function renderLayers(){
      const el=document.getElementById("layersList");
      el.innerHTML=`
        <label><input type="checkbox" id="chkBorders" checked> HATÁR (kontúr)</label><br/>
        <label><input type="checkbox" id="chkHotspots" checked> HOTSPOT</label><br/>
        <label><input type="checkbox" id="chkEarly" checked> EARLY</label><br/>
        <label><input type="checkbox" id="chkGdelt" checked> GDELT (14 nap)</label><br/>
        <label><input type="checkbox" id="chkUsgs"> USGS</label><br/>
        <label><input type="checkbox" id="chkGdacs"> GDACS</label><br/>
      `;
      const bind=(id,layer)=>{ const c=document.getElementById(id); c.onchange=()=>c.checked?layer.addTo(map):map.removeLayer(layer); };
      bind("chkBorders",layerBorders);
      bind("chkHotspots",layerHotspots);
      bind("chkEarly",layerEarly);
      bind("chkGdelt",layerGDELT);
      bind("chkUsgs",layerUSGS);
      bind("chkGdacs",layerGDACS);
    }

    // panel open/close
    const mainPanel=document.getElementById("mainPanel");
    const layersPanel=document.getElementById("layersPanel");
    const hotspotsPanel=document.getElementById("hotspotsPanel");
    const openPanelBtn=document.getElementById("openPanelBtn");
    const openLayersBtn=document.getElementById("openLayersBtn");
    const openHotspotsBtn=document.getElementById("openHotspotsBtn");

    document.getElementById("closeMainPanel").onclick=()=>{ mainPanel.classList.add("hidden"); openPanelBtn.style.display="block"; };
    openPanelBtn.onclick=()=>{ mainPanel.classList.remove("hidden"); openPanelBtn.style.display="none"; };

    document.getElementById("closeLayersPanel").onclick=()=>{ layersPanel.classList.add("hidden"); openLayersBtn.style.display="block"; };
    openLayersBtn.onclick=()=>{ layersPanel.classList.remove("hidden"); openLayersBtn.style.display="none"; };

    document.getElementById("closeHotspotsPanel").onclick=()=>{ hotspotsPanel.classList.add("hidden"); openHotspotsBtn.style.display="block"; };
    openHotspotsBtn.onclick=()=>{ hotspotsPanel.classList.remove("hidden"); openHotspotsBtn.style.display="none"; };

    async function boot(){
      renderLayers();

      try{ layerBorders.addData(await fetchJSON("./data/cee_borders.geojson")).addTo(map); }catch{}
      try{ layerGDELT.addData(await fetchJSON("./data/gdelt.geojson")).addTo(map); }catch(e){ console.warn("gdelt",e); }
      try{ layerUSGS.addData(await fetchJSON("./data/usgs.geojson")); }catch{}
      try{ layerGDACS.addData(await fetchJSON("./data/gdacs.geojson")); }catch{}
      try{ layerHotspots.addData(await fetchJSON("./data/hotspots.geojson")).addTo(map); }catch{}
      try{ layerEarly.addData(await fetchJSON("./data/early.geojson")).addTo(map); }catch{}

      try{
        const meta=await fetchJSON("./data/meta.json");
        document.getElementById("metaLine").textContent =
          `Frissítés: ${fmtTime(meta.generated_utc)} | GDELT (14 nap): ${meta.counts.gdelt_14d} | GDELT (7 nap): ${meta.counts.gdelt_7d}`;
      }catch{}

      try{ const s=await fetchJSON("./data/summary.json"); setBullets("dailyBullets", s.bullets||[]); }catch{}
      try{ const w=await fetchJSON("./data/weekly.json"); setBullets("weeklyBullets", w.bullets||[]); }catch{}
      try{ const e=await fetchJSON("./data/early.json"); document.getElementById("earlyHint").textContent = (e.top||[]).length ? "EARLY: van jelzés (lásd rétegen)." : "EARLY: nincs elég adat."; }catch{}
    }
    boot();
  </script>
</body>
</html>
