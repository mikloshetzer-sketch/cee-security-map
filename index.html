<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Közép–Kelet Európa Biztonsági Monitor</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100vh; width: 100vw; }

    .panel {
      position: absolute;
      z-index: 9999;
      background: rgba(255,255,255,0.95);
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.18);
      padding: 12px 14px;
      font: 14px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      max-width: 420px;
    }
    .panel h2 { margin: 0 0 8px 0; font-size: 16px; }
    .panel h3 { margin: 12px 0 6px 0; font-size: 14px; }
    .panel .muted { color: #666; font-size: 12px; }
    .panel ul { margin: 6px 0 0 18px; padding: 0; }
    .panel li { margin: 4px 0; }
    .row { display:flex; gap: 8px; align-items: center; }
    .btn {
      border: 1px solid #ddd;
      background: #fff;
      border-radius: 10px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 12px;
    }
    .btn:hover { background: #f3f3f3; }

    #summaryPanel { left: 12px; top: 12px; }
    #layersPanel { right: 12px; top: 12px; width: 260px; }
    #hotspotsPanel { right: 12px; bottom: 12px; width: 320px; max-height: 45vh; overflow:auto; }

    .badge { display:inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; border: 1px solid #ddd; background:#fafafa; }
    .badge.red { background:#ffecec; border-color:#ffb4b4; }
    .badge.yellow { background:#fff7d6; border-color:#ffe08a; }
    .badge.blue { background:#e8f2ff; border-color:#a9ccff; }

    .list { margin: 6px 0 0 0; padding: 0; list-style: none; }
    .list li { padding: 8px 10px; border: 1px solid #eee; border-radius: 10px; margin: 6px 0; background:#fff; cursor:pointer; }
    .list li:hover { background:#f7f7f7; }
    .small { font-size: 12px; color:#555; }

    .kv { display:grid; grid-template-columns: 90px 1fr; gap: 4px 10px; font-size: 12px; margin-top:6px; }
    .kv div:nth-child(odd){ color:#666; }

    .toggle { display:flex; align-items:center; gap:8px; margin:6px 0; }
    .toggle input { transform: scale(1.05); }

    .alert { padding: 8px 10px; border-radius: 10px; border: 1px solid #ddd; margin-bottom: 10px; }
    .alert.info { background:#e8f2ff; border-color:#a9ccff; }
    .alert.medium { background:#fff7d6; border-color:#ffe08a; }
    .alert.high { background:#ffecec; border-color:#ffb4b4; }

    a { color: #0b63ce; text-decoration: none; }
    a:hover { text-decoration: underline; }
  </style>
</head>
<body>

<div id="map"></div>

<!-- SUMMARY / DAILY / WEEKLY -->
<div id="summaryPanel" class="panel">
  <div class="row" style="justify-content:space-between;">
    <h2>Közép–Kelet Európa Biztonsági Monitor</h2>
    <button class="btn" id="toggleSummary">Bezár</button>
  </div>
  <div class="muted" id="metaLine">Betöltés…</div>

  <div id="alertBox"></div>

  <h3>Napi kivonat</h3>
  <ul id="dailyBullets"></ul>

  <h3>Heti kivonat (7 nap)</h3>
  <ul id="weeklyBullets"></ul>

  <h3>Early signals (elemző mód)</h3>
  <div class="muted">Megjegyzés: automatikus OSINT-kivonat; a linkelt források kézi ellenőrzése javasolt.</div>
</div>

<!-- LAYERS -->
<div id="layersPanel" class="panel">
  <div class="row" style="justify-content:space-between;">
    <h2>Rétegek</h2>
    <button class="btn" id="toggleLayers">Bezár</button>
  </div>

  <div class="toggle"><input type="checkbox" id="cbBorders" checked><label for="cbBorders">HATÁR <span class="muted">kontúr</span></label></div>
  <div class="toggle"><input type="checkbox" id="cbHotspot" checked><label for="cbHotspot">HOTSPOT <span class="muted">heat</span></label></div>
  <div class="toggle"><input type="checkbox" id="cbEarly"><label for="cbEarly">EARLY <span class="muted">elemző</span></label></div>
  <div class="toggle"><input type="checkbox" id="cbGdelt" checked><label for="cbGdelt">GDELT <span class="muted">hírek</span></label></div>
  <div class="toggle"><input type="checkbox" id="cbUsgs"><label for="cbUsgs">USGS <span class="muted">rengések</span></label></div>
  <div class="toggle"><input type="checkbox" id="cbGdacs"><label for="cbGdacs">GDACS <span class="muted">riasztás</span></label></div>

  <div class="muted" style="margin-top:8px;">
    Esemény színek: 0–24h (friss), 1–3 nap, 3–7 nap, 7+ nap (halvány).
  </div>
</div>

<!-- HOTSPOTS -->
<div id="hotspotsPanel" class="panel">
  <div class="row" style="justify-content:space-between;">
    <h2>Top hotspotok</h2>
    <button class="btn" id="toggleHotspots">Bezár</button>
  </div>
  <ul id="hotspotList" class="list"></ul>
  <div class="muted">Kattints a sorra → zoom.</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  // -----------------------
  // Map init
  // -----------------------
  const map = L.map('map', { zoomControl: true }).setView([47.2, 19.2], 6);

  const base = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19, attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  // -----------------------
  // Helpers
  // -----------------------
  function parseTime(s){
    if(!s) return null;
    const d = new Date(s);
    return isNaN(d.getTime()) ? null : d;
  }
  function ageBucket(timeIso){
    const d = parseTime(timeIso);
    if(!d) return {opacity: 0.55, weight: 1};
    const hours = (Date.now() - d.getTime()) / 3600000;
    if(hours <= 24) return {opacity: 0.95, weight: 2};
    if(hours <= 72) return {opacity: 0.80, weight: 2};
    if(hours <= 168) return {opacity: 0.65, weight: 1};
    return {opacity: 0.40, weight: 1};
  }
  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function categoryLabel(cat){
    const c = (cat || "other").toLowerCase();
    if(c === "military") return "katonai";
    if(c === "police") return "rendőrségi";
    if(c === "cyber") return "kiber";
    if(c === "border") return "határ";
    if(c === "infrastructure") return "infrastruktúra";
    if(c === "natural") return "természeti";
    return "egyéb";
  }

  function buildPopup(props){
    const p = props || {};
    const title = escapeHtml(p.title || "Esemény");
    const time = escapeHtml(p.time || "");
    const source = escapeHtml(p.domain || p.source || "");
    const cat = escapeHtml(categoryLabel(p.category));
    const kind = escapeHtml(p.kind || "");
    const url = p.url || p.query_link || null;

    const linkHtml = url
      ? `<a href="${escapeHtml(url)}" target="_blank" rel="noopener">Forrás megnyitása</a>`
      : `<span class="muted">Nincs forrás link</span>`;

    // plusz: ha query_link külön van
    const extraLink = (p.query_link && p.url && p.query_link !== p.url)
      ? `<div style="margin-top:6px"><a href="${escapeHtml(p.query_link)}" target="_blank" rel="noopener">GDELT keresés (alternatíva)</a></div>`
      : "";

    return `
      <div style="min-width:240px">
        <b>${title}</b>
        <div class="kv">
          <div>Típus:</div><div>${cat}</div>
          <div>Idő:</div><div>${time}</div>
          <div>Forrás:</div><div>${source}</div>
          <div>Jelleg:</div><div>${kind}</div>
        </div>
        <div style="margin-top:8px">${linkHtml}</div>
        ${extraLink}
      </div>
    `;
  }

  // -----------------------
  // Layers
  // -----------------------
  const bordersLayer = L.geoJSON(null, {
    style: { color: '#1d5bd6', weight: 2, opacity: 0.9, fillOpacity: 0 }
  });

  const gdeltLayer = L.geoJSON(null, {
    pointToLayer: (f, latlng) => {
      const a = ageBucket(f?.properties?.time);
      // GDELT pont: piros kör
      return L.circleMarker(latlng, {
        radius: 6,
        color: '#c91818',
        weight: a.weight,
        opacity: a.opacity,
        fillColor: '#ff3b3b',
        fillOpacity: Math.min(0.85, a.opacity)
      });
    },
    onEachFeature: (f, layer) => layer.bindPopup(buildPopup(f.properties))
  });

  const usgsLayer = L.geoJSON(null, {
    pointToLayer: (f, latlng) => {
      const a = ageBucket(f?.properties?.time);
      return L.circleMarker(latlng, {
        radius: 5,
        color: '#444',
        weight: a.weight,
        opacity: a.opacity,
        fillColor: '#777',
        fillOpacity: Math.min(0.75, a.opacity)
      });
    },
    onEachFeature: (f, layer) => layer.bindPopup(buildPopup(f.properties))
  });

  const gdacsLayer = L.geoJSON(null, {
    pointToLayer: (f, latlng) => {
      const a = ageBucket(f?.properties?.time);
      return L.circleMarker(latlng, {
        radius: 6,
        color: '#6a4b00',
        weight: a.weight,
        opacity: a.opacity,
        fillColor: '#ffb000',
        fillOpacity: Math.min(0.80, a.opacity)
      });
    },
    onEachFeature: (f, layer) => layer.bindPopup(buildPopup(f.properties))
  });

  const hotspotsLayer = L.geoJSON(null, {
    pointToLayer: (f, latlng) => {
      const score = Number(f?.properties?.score || 0);
      const r = Math.max(6, Math.min(18, 6 + score * 10));
      return L.circleMarker(latlng, {
        radius: r,
        color: '#0c6d2a',
        weight: 2,
        opacity: 0.9,
        fillColor: '#23c55e',
        fillOpacity: 0.28
      });
    },
    onEachFeature: (f, layer) => {
      const p = f.properties || {};
      const arrow = p.trend_arrow || "";
      const txt = `
        <b>Hotspot</b><br>
        Score: ${escapeHtml(p.score)} ${escapeHtml(arrow)}<br>
        Count: ${escapeHtml(p.count)}<br>
        Források: GDELT ${escapeHtml(p.sources?.GDELT ?? 0)}, USGS ${escapeHtml(p.sources?.USGS ?? 0)}, GDACS ${escapeHtml(p.sources?.GDACS ?? 0)}
      `;
      layer.bindPopup(txt);
    }
  });

  const earlyLayer = L.geoJSON(null, {
    pointToLayer: (f, latlng) => {
      const e = Number(f?.properties?.escalation || 0);
      const r = Math.max(6, Math.min(14, 6 + e/20));
      return L.circleMarker(latlng, {
        radius: r,
        color: '#0b63ce',
        weight: 2,
        opacity: 0.9,
        fillColor: '#4ea3ff',
        fillOpacity: 0.25
      });
    },
    onEachFeature: (f, layer) => {
      const p = f.properties || {};
      layer.bindPopup(`
        <b>Early signal</b><br>
        Escalation: ${escapeHtml(p.escalation)}<br>
        Recent: ${escapeHtml(p.recent)} / Baseline: ${escapeHtml(p.baseline)}<br>
        Zone: ${escapeHtml(p.zone || "-")}
      `);
    }
  });

  // Add defaults
  bordersLayer.addTo(map);
  gdeltLayer.addTo(map);
  hotspotsLayer.addTo(map);

  // -----------------------
  // Fetch data
  // -----------------------
  async function fetchJson(path){
    const r = await fetch(path, { cache: "no-cache" });
    if(!r.ok) throw new Error(`HTTP ${r.status} for ${path}`);
    return await r.json();
  }

  async function loadAll(){
    // meta + summary + weekly
    try {
      const [meta, summary, weekly] = await Promise.all([
        fetchJson("data/meta.json"),
        fetchJson("data/summary.json"),
        fetchJson("data/weekly.json"),
      ]);

      const counts = meta.counts || {};
      const generated = meta.generated_utc || summary.generated_utc || "";
      document.getElementById("metaLine").textContent =
        `Frissítés: ${generated} | hotspot cellák: ${counts.hotspot_cells ?? 0} | GDELT: ${counts.gdelt ?? 0}, USGS: ${counts.usgs ?? 0}, GDACS: ${counts.gdacs ?? 0}`;

      // alert
      const alertBox = document.getElementById("alertBox");
      alertBox.innerHTML = "";
      if(summary.alert){
        const a = summary.alert;
        alertBox.innerHTML = `<div class="alert ${escapeHtml(a.level || "info")}"><b>${escapeHtml(a.title || "")}</b><div>${escapeHtml(a.text || "")}</div></div>`;
      }

      // daily bullets
      const daily = document.getElementById("dailyBullets");
      daily.innerHTML = "";
      (summary.bullets || []).forEach(b => {
        const li = document.createElement("li");
        li.textContent = b;
        daily.appendChild(li);
      });

      // weekly bullets
      const weeklyUl = document.getElementById("weeklyBullets");
      weeklyUl.innerHTML = "";
      (weekly.bullets || []).forEach(b => {
        const li = document.createElement("li");
        li.textContent = b;
        weeklyUl.appendChild(li);
      });

    } catch(e){
      console.warn("summary/meta load failed", e);
      document.getElementById("metaLine").textContent = "Frissítés betöltése nem sikerült.";
    }

    // borders
    try {
      const borders = await fetchJson("data/cee_borders.geojson");
      bordersLayer.clearLayers();
      bordersLayer.addData(borders);
    } catch(e){ console.warn("borders load failed", e); }

    // sources
    try {
      const gdelt = await fetchJson("data/gdelt.geojson");
      gdeltLayer.clearLayers();
      gdeltLayer.addData(gdelt);
    } catch(e){ console.warn("gdelt load failed", e); }

    try {
      const usgs = await fetchJson("data/usgs.geojson");
      usgsLayer.clearLayers();
      usgsLayer.addData(usgs);
    } catch(e){ console.warn("usgs load failed", e); }

    try {
      const gdacs = await fetchJson("data/gdacs.geojson");
      gdacsLayer.clearLayers();
      gdacsLayer.addData(gdacs);
    } catch(e){ console.warn("gdacs load failed", e); }

    // hotspots + list
    try {
      const [hotspotsGeo, hotspotsTop] = await Promise.all([
        fetchJson("data/hotspots.geojson"),
        fetchJson("data/hotspots.json"),
      ]);
      hotspotsLayer.clearLayers();
      hotspotsLayer.addData(hotspotsGeo);

      const ul = document.getElementById("hotspotList");
      ul.innerHTML = "";
      const top = (hotspotsTop.top || []);
      if(top.length === 0){
        ul.innerHTML = `<li class="small">Nincs elég adat.</li>`;
      } else {
        top.forEach((h) => {
          const li = document.createElement("li");
          const place = h.place || "n/a";
          const score = h.score ?? 0;
          const arrow = h.trend_arrow || "";
          li.innerHTML = `<b>${escapeHtml(place)}</b> <span class="badge blue">S=${escapeHtml(arrow)} ${escapeHtml(score)}</span>
                          <div class="small">(${h.lat.toFixed(2)}, ${h.lon.toFixed(2)}) · 7 nap: ${h.change_pct==null?"n/a":(h.change_pct+"%")}</div>`;
          li.addEventListener("click", () => {
            map.setView([h.lat, h.lon], 8);
          });
          ul.appendChild(li);
        });
      }
    } catch(e){ console.warn("hotspots load failed", e); }

    // early
    try {
      const early = await fetchJson("data/early.geojson");
      earlyLayer.clearLayers();
      earlyLayer.addData(early);
    } catch(e){ console.warn("early load failed", e); }
  }

  loadAll();

  // -----------------------
  // UI toggles
  // -----------------------
  function setLayer(lyr, on){
    if(on){ lyr.addTo(map); } else { map.removeLayer(lyr); }
  }

  document.getElementById("cbBorders").addEventListener("change", e => setLayer(bordersLayer, e.target.checked));
  document.getElementById("cbHotspot").addEventListener("change", e => setLayer(hotspotsLayer, e.target.checked));
  document.getElementById("cbEarly").addEventListener("change", e => setLayer(earlyLayer, e.target.checked));
  document.getElementById("cbGdelt").addEventListener("change", e => setLayer(gdeltLayer, e.target.checked));
  document.getElementById("cbUsgs").addEventListener("change", e => setLayer(usgsLayer, e.target.checked));
  document.getElementById("cbGdacs").addEventListener("change", e => setLayer(gdacsLayer, e.target.checked));

  function togglePanel(btnId, panelId){
    const btn = document.getElementById(btnId);
    const panel = document.getElementById(panelId);
    btn.addEventListener("click", () => {
      const isHidden = panel.style.display === "none";
      panel.style.display = isHidden ? "block" : "none";
      btn.textContent = isHidden ? "Bezár" : "Kinyit";
    });
  }
  togglePanel("toggleSummary", "summaryPanel");
  togglePanel("toggleLayers", "layersPanel");
  togglePanel("toggleHotspots", "hotspotsPanel");

</script>
</body>
</html>
