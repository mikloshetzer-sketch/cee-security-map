<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>K√∂z√©p‚ÄìKelet Eur√≥pa biztons√°gi monitor</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root{
      --panel-bg: rgba(255,255,255,.96);
      --panel-border: rgba(0,0,0,.10);
      --shadow: 0 10px 30px rgba(0,0,0,.18);
      --radius: 14px;
      --text: #111827;
      --muted: #6b7280;
      --accent: #2563eb;
      --danger: #b91c1c;
      --warn: #b45309;
      --ok: #047857;

      --btn-bg: rgba(255,255,255,.92);
      --btn-border: rgba(0,0,0,.14);
      --btn-shadow: 0 8px 20px rgba(0,0,0,.14);

      --z-ui: 1000;
      --z-banner: 1100;

      /* layout spacing */
      --gap: 10px;
      --top-safe: max(env(safe-area-inset-top), 8px);
      --right-safe: max(env(safe-area-inset-right), 8px);
      --left-safe: max(env(safe-area-inset-left), 8px);
      --bottom-safe: max(env(safe-area-inset-bottom), 8px);
    }

    html, body { height: 100%; margin: 0; background: #0b1220; }
    #map { height: 100vh; width: 100vw; }

    /* Banner (alert) */
    #alertBar{
      position: fixed;
      top: var(--top-safe);
      left: 50%;
      transform: translateX(-50%);
      z-index: var(--z-banner);
      max-width: min(980px, calc(100vw - 24px));
      width: calc(100vw - 24px);
      background: rgba(255,255,255,.95);
      border: 1px solid var(--panel-border);
      border-radius: 999px;
      box-shadow: var(--shadow);
      padding: 8px 12px;
      display: none;
      align-items: center;
      gap: 10px;
      color: var(--text);
      font: 14px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    #alertPill{
      padding: 4px 10px;
      border-radius: 999px;
      font-weight: 700;
      white-space: nowrap;
      font-size: 12px;
    }
    #alertText{ flex: 1; }
    #alertClose{
      border: 0;
      background: transparent;
      font-size: 18px;
      cursor: pointer;
      padding: 0 6px;
      color: var(--muted);
    }

    /* Floating open buttons */
    .fab{
      position: fixed;
      z-index: var(--z-ui);
      border: 1px solid var(--btn-border);
      background: var(--btn-bg);
      box-shadow: var(--btn-shadow);
      border-radius: 999px;
      padding: 10px 12px;
      font: 13px/1 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      cursor: pointer;
      display: inline-flex;
      gap: 8px;
      align-items: center;
      user-select: none;
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }
    .fab small{ color: var(--muted); font-weight: 600; }
    .fab:active{ transform: translateY(1px); }

    /* Place FABs so they never collide with Leaflet zoom controls */
    #btnOpenSummary{ top: calc(var(--top-safe) + 56px); left: var(--left-safe); }
    #btnOpenLayers{  top: calc(var(--top-safe) + 102px); left: var(--left-safe); }
    #btnOpenHotspots{ top: calc(var(--top-safe) + 148px); left: var(--left-safe); }
    #btnOpenLegend{  bottom: calc(var(--bottom-safe) + 12px); right: var(--right-safe); }
    #btnToday{       top: calc(var(--top-safe) + 56px); right: var(--right-safe); }

    /* Panels */
    .panel{
      position: fixed;
      z-index: var(--z-ui);
      background: var(--panel-bg);
      border: 1px solid var(--panel-border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      color: var(--text);
      font: 14px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      overflow: hidden;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    .panel .head{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(0,0,0,.08);
      font-weight: 800;
    }
    .panel .head .sub{
      font-weight: 600;
      color: var(--muted);
      font-size: 12px;
      margin-left: 6px;
    }
    .panel .body{
      padding: 10px 12px;
      max-height: min(62vh, 520px);
      overflow: auto;
    }
    .panel .close{
      border: 1px solid rgba(0,0,0,.14);
      background: rgba(255,255,255,.92);
      border-radius: 10px;
      cursor: pointer;
      padding: 6px 10px;
      font-weight: 700;
      color: var(--text);
    }

    /* Summary panel layout */
    #summaryPanel{
      top: calc(var(--top-safe) + 56px);
      left: var(--left-safe);
      width: min(430px, calc(100vw - 16px));
    }

    /* Layers panel */
    #layersPanel{
      top: calc(var(--top-safe) + 56px);
      right: var(--right-safe);
      width: min(320px, calc(100vw - 16px));
    }

    /* Hotspots panel */
    #hotspotsPanel{
      bottom: calc(var(--bottom-safe) + 12px);
      left: var(--left-safe);
      width: min(360px, calc(100vw - 16px));
    }

    /* Legend panel (narrow) */
    #legendPanel{
      bottom: calc(var(--bottom-safe) + 12px);
      right: var(--right-safe);
      width: min(260px, calc(100vw - 16px));
    }

    /* Collapsed panels hidden, but FAB stays */
    .hidden{ display: none !important; }

    /* Collapsible sections inside summary */
    details{
      border: 1px solid rgba(0,0,0,.10);
      border-radius: 12px;
      background: rgba(255,255,255,.75);
      margin: 8px 0;
      overflow: hidden;
    }
    summary{
      cursor: pointer;
      list-style: none;
      padding: 10px 12px;
      font-weight: 800;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    summary::-webkit-details-marker { display: none; }
    details .content{ padding: 0 12px 12px 12px; color: var(--text); }
    .muted{ color: var(--muted); }
    .small{ font-size: 12px; }

    /* Filter bar (top right) */
    .chipRow{
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      padding: 8px 10px;
    }
    .chip{
      border: 1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.92);
      border-radius: 999px;
      padding: 7px 10px;
      font-weight: 800;
      font-size: 12px;
      cursor: pointer;
      user-select: none;
    }
    .chip.active{
      background: rgba(37,99,235,.12);
      border-color: rgba(37,99,235,.35);
      color: #1e40af;
    }

    /* Hotspot list */
    .list{
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .item{
      border: 1px solid rgba(0,0,0,.10);
      border-radius: 12px;
      padding: 10px 10px;
      background: rgba(255,255,255,.8);
      cursor: pointer;
    }
    .item .t{ font-weight: 900; }
    .item .m{ color: var(--muted); font-size: 12px; margin-top: 2px; }
    .badge{
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      padding: 3px 10px;
      font-size: 12px;
      font-weight: 900;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.9);
    }

    /* Popup */
    .popup { font: 13px/1.25 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .popup-title{ font-weight: 900; margin-bottom: 6px; }
    .popup-meta{ white-space: pre-line; color: #111827; margin-bottom: 6px; }
    .popup-link a{
      display: inline-block;
      font-weight: 900;
      color: var(--accent);
      text-decoration: none;
    }
    .popup-link a:hover{ text-decoration: underline; }

    /* Make Leaflet controls not collide */
    .leaflet-top.leaflet-left { margin-top: calc(var(--top-safe) + 10px); margin-left: calc(var(--left-safe) + 10px); }
    .leaflet-control-zoom { box-shadow: var(--btn-shadow); border: 1px solid var(--btn-border); border-radius: 12px; overflow: hidden; }

    /* Mobile tweaks */
    @media (max-width: 720px){
      #summaryPanel, #layersPanel, #hotspotsPanel, #legendPanel{
        width: calc(100vw - 16px);
        left: var(--left-safe);
        right: var(--right-safe);
      }
      #summaryPanel{ top: calc(var(--top-safe) + 56px); }
      #layersPanel{ top: calc(var(--top-safe) + 56px); }
      #hotspotsPanel{ bottom: calc(var(--bottom-safe) + 12px); }
      #legendPanel{ bottom: calc(var(--bottom-safe) + 12px); }

      /* On mobile, legend FAB stays but legend panel starts closed */
      #btnOpenLegend{ right: var(--right-safe); }

      /* Move open buttons down so they don't conflict with zoom */
      #btnOpenSummary{ top: calc(var(--top-safe) + 68px); }
      #btnOpenLayers{ top: calc(var(--top-safe) + 116px); }
      #btnOpenHotspots{ top: calc(var(--top-safe) + 164px); }
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <!-- Alert banner -->
  <div id="alertBar" role="status" aria-live="polite">
    <span id="alertPill">RIASZT√ÅS</span>
    <div id="alertText"></div>
    <button id="alertClose" aria-label="Bez√°r√°s">√ó</button>
  </div>

  <!-- Floating open buttons (always available) -->
  <button class="fab" id="btnOpenSummary">üìÑ <b>Kivonatok</b> <small>(napi/heti)</small></button>
  <button class="fab" id="btnOpenLayers">üß© <b>R√©tegek</b></button>
  <button class="fab" id="btnOpenHotspots">üî• <b>Hotspotok</b></button>
  <button class="fab" id="btnOpenLegend">üó∫Ô∏è <b>Jelmagyar√°zat</b></button>

  <!-- Quick filter button top-right -->
  <div class="panel" id="filterPanel" style="top: calc(var(--top-safe) + 56px); right: var(--right-safe); border-radius: 16px; width:min(340px, calc(100vw - 16px));">
    <div class="head">
      <div>Mai esem√©nyek <span class="sub" id="filterSub">‚Äî</span></div>
      <button class="close" id="filterClose">Bez√°r</button>
    </div>
    <div class="chipRow" id="chipRow">
      <div class="chip active" data-range="today">Mai h√≠rek</div>
      <div class="chip" data-range="24h">24 √≥ra</div>
      <div class="chip" data-range="7d">7 nap</div>
      <div class="chip" data-range="alerts">Mai riaszt√°s</div>
    </div>
    <div class="body small muted" id="filterHint">
      Tipp: ‚ÄûMai h√≠rek‚Äù a GDELT pontokat sz≈±ri. ‚ÄûMai riaszt√°s‚Äù a GDACS/USGS friss jelz√©sekre f√≥kusz√°l.
    </div>
  </div>

  <!-- Summary Panel (default closed) -->
  <div class="panel hidden" id="summaryPanel">
    <div class="head">
      <div>K√∂z√©p‚ÄìKelet Eur√≥pa Biztons√°gi Monitor <span class="sub" id="summaryStamp">‚Äî</span></div>
      <button class="close" data-close="#summaryPanel">Bez√°r</button>
    </div>
    <div class="body" id="summaryBody">
      <div class="muted small">Bet√∂lt√©s‚Ä¶</div>
    </div>
  </div>

  <!-- Layers Panel (default closed) -->
  <div class="panel hidden" id="layersPanel">
    <div class="head">
      <div>R√©tegek</div>
      <button class="close" data-close="#layersPanel">Bez√°r</button>
    </div>
    <div class="body" id="layersBody">
      <label><input type="checkbox" id="chkBorders" checked /> HAT√ÅR (kont√∫r)</label><br/>
      <label><input type="checkbox" id="chkHotspots" checked /> HOTSPOT (heat)</label><br/>
      <label><input type="checkbox" id="chkEarly" checked /> EARLY (elemz≈ë)</label><br/>
      <label><input type="checkbox" id="chkGdelt" checked /> GDELT (h√≠rek)</label><br/>
      <label><input type="checkbox" id="chkUsgs" /> USGS (reng√©sek)</label><br/>
      <label><input type="checkbox" id="chkGdacs" /> GDACS (riaszt√°s)</label>

      <div class="muted small" style="margin-top:10px;">
        Esem√©nyek sz√≠nei: GDELT kateg√≥ria szerint (kiber/energia/hat√°r/t√ºntet√©s/katonai stb). USGS/GDACS k√ºl√∂n.
      </div>
    </div>
  </div>

  <!-- Hotspots Panel (default closed) -->
  <div class="panel hidden" id="hotspotsPanel">
    <div class="head">
      <div>Top hotspotok</div>
      <button class="close" data-close="#hotspotsPanel">Bez√°r</button>
    </div>
    <div class="body">
      <div class="list" id="hotspotList">
        <div class="muted small">Bet√∂lt√©s‚Ä¶</div>
      </div>
      <div class="muted small" style="margin-top:10px;">Kattints a sorra ‚Üí zoom a r√°cspontra.</div>
    </div>
  </div>

  <!-- Legend Panel (default closed on mobile) -->
  <div class="panel hidden" id="legendPanel">
    <div class="head">
      <div>Jelmagyar√°zat</div>
      <button class="close" data-close="#legendPanel">Bez√°r</button>
    </div>
    <div class="body small" id="legendBody">
      <div style="display:flex; flex-direction:column; gap:8px;">
        <div class="badge"><span style="color:#ef4444;">‚óè</span> T√ºntet√©s / zavarg√°s</div>
        <div class="badge"><span style="color:#f97316;">‚óè</span> Hat√°r / migr√°ci√≥ / csemp√©szet</div>
        <div class="badge"><span style="color:#eab308;">‚óè</span> Katonai / biztons√°gpolitika</div>
        <div class="badge"><span style="color:#22c55e;">‚óè</span> Rend≈ërs√©gi / igazs√°g√ºgyi</div>
        <div class="badge"><span style="color:#3b82f6;">‚óè</span> Kiber / dezinform√°ci√≥</div>
        <div class="badge"><span style="color:#a855f7;">‚óè</span> Energia / infrastrukt√∫ra</div>
        <div class="badge"><span style="color:#64748b;">‚óè</span> Egy√©b / √°ltal√°nos</div>
        <div class="muted" style="margin-top:8px;">
          A sz√≠n a GDELT pontok ‚Äûcategory‚Äù mez≈ëj√©n alapul. USGS/GDACS pontok saj√°t sz√≠nt kapnak.
        </div>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // Helpers
    // =========================
    const DATA_BASE = "./data";

    const $ = (sel) => document.querySelector(sel);

    function safeText(x){ return (x === null || x === undefined || x === "") ? "‚Äî" : String(x); }

    function parseAnyTime(props){
      // supports ISO in props.time, or props.date (YYYY-MM-DD)
      const t = props.time || props.datetime || props.date || props.generated_utc;
      if (!t) return null;
      const d = new Date(t);
      if (!isNaN(d.getTime())) return d;
      // try YYYY-MM-DD
      if (typeof t === "string" && /^\d{4}-\d{2}-\d{2}$/.test(t)){
        const d2 = new Date(t + "T00:00:00Z");
        if (!isNaN(d2.getTime())) return d2;
      }
      return null;
    }

    function pickUrl(props) {
      return (
        props.url ||
        props.sourceurl ||
        props.sourceUrl ||
        (Array.isArray(props.urls) && props.urls[0]) ||
        (Array.isArray(props.sources) && props.sources[0]) ||
        null
      );
    }

    function buildPopupNode(props) {
      const wrap = document.createElement("div");
      wrap.className = "popup";

      const title = document.createElement("div");
      title.className = "popup-title";
      title.textContent = props.title || props.location || props.place || "Esem√©ny";
      wrap.appendChild(title);

      const meta = document.createElement("div");
      meta.className = "popup-meta";

      const when = props.time || props.date || props.seendate || "‚Äî";
      const cat  = props.category || props.attack_type || props.kind || props.type || "‚Äî";
      const src  = props.source || props.domain || "‚Äî";

      meta.textContent =
        `Id≈ë: ${safeText(when)}\n` +
        `T√≠pus: ${safeText(cat)}\n` +
        `Forr√°s: ${safeText(src)}`;

      wrap.appendChild(meta);

      const linkRow = document.createElement("div");
      linkRow.className = "popup-link";

      const url = pickUrl(props);
      if (url) {
        const a = document.createElement("a");
        a.href = url;
        a.target = "_blank";
        a.rel = "noopener noreferrer";
        a.textContent = "Forr√°s megnyit√°sa";
        linkRow.appendChild(a);
      } else {
        linkRow.textContent = "Nincs link az adatban.";
        linkRow.classList.add("muted");
      }
      wrap.appendChild(linkRow);

      return wrap;
    }

    // Map category ‚Üí color
    function catColor(props){
      const c = (props.category || props.attack_type || props.kind || "").toLowerCase();

      // You said: kiber, energia, hat√°r, t√ºntet√©s, katonai, security politics, dr√≥n
      if (c.includes("cyber") || c.includes("kiber") || c.includes("disinfo")) return "#3b82f6";
      if (c.includes("energy") || c.includes("energia") || c.includes("infrastructure") || c.includes("pipeline") || c.includes("power")) return "#a855f7";
      if (c.includes("border") || c.includes("hat√°r") || c.includes("migrant") || c.includes("smuggl")) return "#f97316";
      if (c.includes("protest") || c.includes("t√ºnt") || c.includes("riot") || c.includes("demonstration") || c.includes("clash")) return "#ef4444";
      if (c.includes("military") || c.includes("katon") || c.includes("troop") || c.includes("deployment") || c.includes("exercise") || c.includes("drone") || c.includes("uav")) return "#eab308";
      if (c.includes("police") || c.includes("rend") || c.includes("arrest") || c.includes("court") || c.includes("detain")) return "#22c55e";
      if (c.includes("security") || c.includes("politics")) return "#eab308";

      return "#64748b";
    }

    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    // =========================
    // Panels open/close
    // =========================
    function openPanel(id){ $(id).classList.remove("hidden"); }
    function closePanel(id){ $(id).classList.add("hidden"); }

    $("#btnOpenSummary").addEventListener("click", () => openPanel("#summaryPanel"));
    $("#btnOpenLayers").addEventListener("click", () => openPanel("#layersPanel"));
    $("#btnOpenHotspots").addEventListener("click", () => openPanel("#hotspotsPanel"));
    $("#btnOpenLegend").addEventListener("click", () => openPanel("#legendPanel"));

    document.querySelectorAll("[data-close]").forEach(btn=>{
      btn.addEventListener("click", () => closePanel(btn.getAttribute("data-close")));
    });

    // Filter panel close
    $("#filterClose").addEventListener("click", () => $("#filterPanel").classList.add("hidden"));
    // Quick open filter with top-right FAB style behavior: reuse btnToday location
    // We'll just keep it visible by default; on mobile it can be closed and stays closed until refresh.

    // =========================
    // Leaflet map
    // =========================
    const map = L.map("map", { zoomControl: true });

    const osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 18,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // Default view roughly over CEE
    map.setView([49.3, 19.3], 5);

    // Layer groups
    const gBorders = L.geoJSON(null, { style: { color: "#2563eb", weight: 2, fill: false } });
    const gHotspots = L.geoJSON(null, {
      pointToLayer: (f, latlng) => L.circleMarker(latlng, {
        radius: 10,
        color: "#ef4444",
        weight: 2,
        fillColor: "#ef4444",
        fillOpacity: 0.15
      }),
      onEachFeature: (f, layer) => {
        const p = f.properties || {};
        const node = buildPopupNode({
          title: "Hotspot",
          time: "‚Äî",
          category: "hotspot",
          source: "hotspots",
          url: null,
          location: `R√°cspont: ${p ? (p.cell_deg ? (p.cell_deg + "¬∞") : "‚Äî") : "‚Äî"}`
        });
        layer.bindPopup(node, { maxWidth: 320 });
      }
    });

    const gEarly = L.geoJSON(null, {
      pointToLayer: (f, latlng) => L.circleMarker(latlng, {
        radius: 8,
        color: "#0ea5e9",
        weight: 2,
        fillColor: "#0ea5e9",
        fillOpacity: 0.18
      }),
      onEachFeature: (f, layer) => {
        const p = f.properties || {};
        layer.on("click", () => {
          const node = buildPopupNode({
            title: "Early warning",
            time: "‚Äî",
            category: "early",
            source: "early",
            url: null,
            location: (p.place ? p.place : "‚Äî")
          });
          layer.bindPopup(node, { maxWidth: 320 }).openPopup();
        });
      }
    });

    // Event layers will be rebuilt from cached GeoJSON when filters change
    let gdeltData = null;
    let usgsData = null;
    let gdacsData = null;

    const gGdelt = L.geoJSON(null, {
      pointToLayer: (f, latlng) => {
        const p = f.properties || {};
        const col = catColor(p);
        return L.circleMarker(latlng, { radius: 7, color: col, weight: 2, fillColor: col, fillOpacity: 0.25 });
      },
      onEachFeature: (f, layer) => {
        const p = f.properties || {};
        layer.on("click", () => {
          const node = buildPopupNode(p);
          layer.bindPopup(node, { maxWidth: 320 }).openPopup();
        });
      }
    });

    const gUsgs = L.geoJSON(null, {
      pointToLayer: (f, latlng) => L.circleMarker(latlng, {
        radius: 6,
        color: "#111827",
        weight: 2,
        fillColor: "#111827",
        fillOpacity: 0.22
      }),
      onEachFeature: (f, layer) => {
        const p = f.properties || {};
        layer.on("click", () => {
          const node = buildPopupNode({
            ...p,
            category: "USGS earthquake"
          });
          layer.bindPopup(node, { maxWidth: 320 }).openPopup();
        });
      }
    });

    const gGdacs = L.geoJSON(null, {
      pointToLayer: (f, latlng) => L.circleMarker(latlng, {
        radius: 6,
        color: "#7c2d12",
        weight: 2,
        fillColor: "#7c2d12",
        fillOpacity: 0.22
      }),
      onEachFeature: (f, layer) => {
        const p = f.properties || {};
        layer.on("click", () => {
          const node = buildPopupNode({
            ...p,
            category: "GDACS alert"
          });
          layer.bindPopup(node, { maxWidth: 320 }).openPopup();
        });
      }
    });

    // Add default layers
    gBorders.addTo(map);
    gHotspots.addTo(map);
    gEarly.addTo(map);
    gGdelt.addTo(map);
    // USGS/GDACS OFF by default (checkbox controls)
    // gUsgs.addTo(map);
    // gGdacs.addTo(map);

    // =========================
    // Fetch helpers
    // =========================
    async function fetchJson(path){
      const r = await fetch(path, { cache: "no-store" });
      if(!r.ok) throw new Error(`Fetch failed ${path} (${r.status})`);
      return await r.json();
    }

    // =========================
    // Filtering ranges
    // =========================
    function startOfTodayLocal(){
      const now = new Date();
      const d = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      return d;
    }

    function withinRange(props, range){
      const d = parseAnyTime(props);
      if(!d) return false;

      const now = new Date();
      if(range === "7d"){
        return d >= new Date(now.getTime() - 7*24*3600*1000);
      }
      if(range === "24h"){
        return d >= new Date(now.getTime() - 24*3600*1000);
      }
      if(range === "today"){
        return d >= startOfTodayLocal();
      }
      if(range === "alerts"){
        // alerts focuses on last 24h for GDACS/USGS and "today" for GDELT
        // we'll handle by caller
        return true;
      }
      return true;
    }

    function rebuildEventLayers(activeRange){
      // Clear layers
      gGdelt.clearLayers();
      gUsgs.clearLayers();
      gGdacs.clearLayers();

      const now = new Date();
      const stamp = now.toLocaleString("hu-HU");
      $("#filterSub").textContent = stamp;

      // Build filtered collections
      if (gdeltData && gdeltData.features){
        const feats = gdeltData.features.filter(f => withinRange(f.properties || {}, activeRange === "alerts" ? "today" : activeRange));
        gGdelt.addData({ type:"FeatureCollection", features: feats });
      }

      if (usgsData && usgsData.features){
        const feats = usgsData.features.filter(f => withinRange(f.properties || {}, activeRange === "alerts" ? "24h" : activeRange));
        gUsgs.addData({ type:"FeatureCollection", features: feats });
      }

      if (gdacsData && gdacsData.features){
        const feats = gdacsData.features.filter(f => withinRange(f.properties || {}, activeRange === "alerts" ? "24h" : activeRange));
        gGdacs.addData({ type:"FeatureCollection", features: feats });
      }
    }

    // =========================
    // UI: chips
    // =========================
    let currentRange = "today";
    function setActiveChip(range){
      currentRange = range;
      document.querySelectorAll(".chip").forEach(ch => ch.classList.toggle("active", ch.dataset.range === range));
      rebuildEventLayers(range);
    }
    document.querySelectorAll(".chip").forEach(ch => {
      ch.addEventListener("click", () => setActiveChip(ch.dataset.range));
    });

    // =========================
    // Layer checkbox wiring
    // =========================
    $("#chkBorders").addEventListener("change", (e) => e.target.checked ? gBorders.addTo(map) : map.removeLayer(gBorders));
    $("#chkHotspots").addEventListener("change", (e) => e.target.checked ? gHotspots.addTo(map) : map.removeLayer(gHotspots));
    $("#chkEarly").addEventListener("change", (e) => e.target.checked ? gEarly.addTo(map) : map.removeLayer(gEarly));
    $("#chkGdelt").addEventListener("change", (e) => e.target.checked ? gGdelt.addTo(map) : map.removeLayer(gGdelt));
    $("#chkUsgs").addEventListener("change", (e) => e.target.checked ? gUsgs.addTo(map) : map.removeLayer(gUsgs));
    $("#chkGdacs").addEventListener("change", (e) => e.target.checked ? gGdacs.addTo(map) : map.removeLayer(gGdacs));

    // =========================
    // Summary + hotspots rendering
    // =========================
    function renderSummary(summary, weekly, earlyTop){
      const stamp = summary?.generated_utc ? summary.generated_utc.replace("T"," ").replace("Z"," UTC") : "‚Äî";
      $("#summaryStamp").textContent = `Friss√≠t√©s: ${stamp}`;

      const dailyBullets = (summary?.bullets || []).map(b => `<li>${escapeHtml(b)}</li>`).join("");
      const weeklyBullets = (weekly?.bullets || []).map(b => `<li>${escapeHtml(b)}</li>`).join("");
      const earlyRows = (earlyTop?.top || []).slice(0,10).map(r => {
        const place = r.place || "‚Äî";
        const esc = r.escalation ?? "‚Äî";
        return `<li><b>${escapeHtml(place)}</b> <span class="muted">¬∑ score: ${escapeHtml(String(esc))}</span></li>`;
      }).join("");

      $("#summaryBody").innerHTML = `
        <details>
          <summary>‚ñº Napi kivonat <span class="muted small">${escapeHtml(summary?.headline || "")}</span></summary>
          <div class="content">
            <ul>${dailyBullets || "<li class='muted'>Nincs adat.</li>"}</ul>
          </div>
        </details>

        <details>
          <summary>‚ñº Heti kivonat <span class="muted small">${escapeHtml(weekly?.headline || "elm√∫lt 7 nap")}</span></summary>
          <div class="content">
            <ul>${weeklyBullets || "<li class='muted'>Nincs adat.</li>"}</ul>
          </div>
        </details>

        <details>
          <summary>‚ñº Early signals (elemz≈ë m√≥d)</summary>
          <div class="content">
            <ul>${earlyRows || "<li class='muted'>Nincs el√©g adat.</li>"}</ul>
            <div class="muted small" style="margin-top:8px;">
              Megjegyz√©s: automatikus jelz√©s; a linkelt forr√°sok k√©zi ellen≈ërz√©se javasolt.
            </div>
          </div>
        </details>

        <div class="muted small" style="margin-top:10px;">
          Mobilon a panelek alapb√≥l z√°rva vannak. A bal oldali gombokkal b√°rmikor kinyithat√≥k.
        </div>
      `;
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    function renderHotspots(top){
      const list = $("#hotspotList");
      const arr = (top?.top || []).slice(0,10);

      if(!arr.length){
        list.innerHTML = `<div class="muted small">Nincs el√©g adat.</div>`;
        return;
      }

      list.innerHTML = arr.map(h => {
        const place = h.place || "ismeretlen t√©rs√©g";
        const arrow = h.trend_arrow || "";
        const score = h.score ?? "‚Äî";
        return `
          <div class="item" data-lat="${h.lat}" data-lon="${h.lon}">
            <div class="t">${escapeHtml(place)} ${escapeHtml(arrow)}</div>
            <div class="m">score: ${escapeHtml(String(score))} ¬∑ r√°cspont: ${h.lat.toFixed(2)}, ${h.lon.toFixed(2)}</div>
          </div>
        `;
      }).join("");

      list.querySelectorAll(".item").forEach(el=>{
        el.addEventListener("click", ()=>{
          const lat = parseFloat(el.dataset.lat);
          const lon = parseFloat(el.dataset.lon);
          if(!isNaN(lat) && !isNaN(lon)){
            map.setView([lat, lon], 8, { animate: true });
          }
        });
      });
    }

    // =========================
    // Alert bar
    // =========================
    function showAlert(alert){
      if(!alert) return;
      const bar = $("#alertBar");
      const pill = $("#alertPill");
      const text = $("#alertText");

      const level = (alert.level || "info").toLowerCase();
      pill.textContent = alert.title || "RIASZT√ÅS";

      if(level === "high"){
        pill.style.background = "rgba(185,28,28,.12)";
        pill.style.color = "#991b1b";
        pill.style.border = "1px solid rgba(185,28,28,.25)";
      } else if(level === "medium"){
        pill.style.background = "rgba(180,83,9,.12)";
        pill.style.color = "#92400e";
        pill.style.border = "1px solid rgba(180,83,9,.25)";
      } else {
        pill.style.background = "rgba(37,99,235,.12)";
        pill.style.color = "#1e40af";
        pill.style.border = "1px solid rgba(37,99,235,.25)";
      }

      text.textContent = alert.text || "";
      bar.style.display = "flex";
    }

    $("#alertClose").addEventListener("click", ()=> $("#alertBar").style.display = "none");

    // =========================
    // Boot
    // =========================
    async function init(){
      // On mobile: keep legend closed by default
      if (window.matchMedia && window.matchMedia("(max-width: 720px)").matches){
        closePanel("#legendPanel");
      }

      // Load borders
      try {
        const borders = await fetchJson(`${DATA_BASE}/cee_borders.geojson`);
        gBorders.addData(borders);
        // Fit to borders once on load
        const b = gBorders.getBounds();
        if (b && b.isValid()) map.fitBounds(b.pad(0.08));
      } catch(e){ console.warn("borders load failed", e); }

      // Load hotspots + early
      try {
        const hs = await fetchJson(`${DATA_BASE}/hotspots.geojson`);
        gHotspots.addData(hs);
      } catch(e){ console.warn("hotspots geojson failed", e); }

      try {
        const er = await fetchJson(`${DATA_BASE}/early.geojson`);
        gEarly.addData(er);
      } catch(e){ console.warn("early geojson failed", e); }

      // Load event datasets
      try { gdeltData = await fetchJson(`${DATA_BASE}/gdelt.geojson`); } catch(e){ console.warn("gdelt load failed", e); }
      try { usgsData  = await fetchJson(`${DATA_BASE}/usgs.geojson`); } catch(e){ console.warn("usgs load failed", e); }
      try { gdacsData = await fetchJson(`${DATA_BASE}/gdacs.geojson`); } catch(e){ console.warn("gdacs load failed", e); }

      // Apply default filter
      rebuildEventLayers(currentRange);

      // Load top hotspot list + summaries
      let summary=null, weekly=null, earlyTop=null, hotTop=null, meta=null;
      try { meta = await fetchJson(`${DATA_BASE}/meta.json`); } catch(e){}
      try { summary = await fetchJson(`${DATA_BASE}/summary.json`); } catch(e){}
      try { weekly  = await fetchJson(`${DATA_BASE}/weekly.json`); } catch(e){}
      try { earlyTop= await fetchJson(`${DATA_BASE}/early.json`); } catch(e){}
      try { hotTop  = await fetchJson(`${DATA_BASE}/hotspots.json`); } catch(e){}

      renderSummary(summary, weekly, earlyTop);
      renderHotspots(hotTop);
      showAlert(summary?.alert);

      // Update filter subtitle with "Budapest" style stamp if available
      try{
        const stamp = meta?.generated_utc ? meta.generated_utc.replace("T"," ").replace("Z"," UTC") : "";
        $("#filterSub").textContent = stamp ? stamp : (new Date().toLocaleString("hu-HU"));
      }catch{}

      // Default: panels closed (as requested)
      closePanel("#summaryPanel");
      closePanel("#layersPanel");
      closePanel("#hotspotsPanel");
      // legend stays closed; user opens via FAB
    }

    init();
  </script>
</body>
</html>
