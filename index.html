<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Közép–Kelet Európa Biztonsági Monitor</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --panel-bg: rgba(255,255,255,0.92);
      --panel-border: rgba(0,0,0,0.10);
      --text: #111827;
      --muted: #6b7280;
      --brand: #2563eb;
    }
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color: var(--text); }
    #map { height: 100%; width: 100%; }

    .panel {
      position: absolute;
      z-index: 1000;
      background: var(--panel-bg);
      border: 1px solid var(--panel-border);
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.12);
      backdrop-filter: blur(6px);
    }

    .panel h1, .panel h2 { margin: 0 0 8px 0; font-size: 14px; }
    .panel .small { font-size: 12px; color: var(--muted); }
    .panel .muted { color: var(--muted); }
    .panel .btn {
      cursor: pointer;
      border: 1px solid var(--panel-border);
      background: white;
      border-radius: 10px;
      padding: 6px 10px;
      font-size: 12px;
    }
    .panel .btn:hover { border-color: rgba(0,0,0,0.22); }
    .row { display:flex; align-items:center; gap:8px; }
    .row.space { justify-content: space-between; }
    .hr { height:1px; background: rgba(0,0,0,0.08); margin: 10px 0; }

    /* Sidebar */
    #sidebar {
      top: 12px;
      left: 12px;
      width: 360px;
      max-width: calc(100% - 24px);
      padding: 12px 12px 10px 12px;
    }
    #sidebar .titlebar { display:flex; align-items:flex-start; justify-content: space-between; gap: 10px; }
    #sidebar .title { font-weight: 800; font-size: 13px; line-height: 1.2; }
    #sidebar .section { margin-top: 10px; }
    #sidebar ul { margin: 8px 0 0 18px; padding:0; }
    #sidebar li { margin: 4px 0; font-size: 12px; }
    #alertBox {
      display:none;
      margin-top: 10px;
      border-radius: 12px;
      padding: 10px;
      border: 1px solid rgba(0,0,0,0.10);
      background: rgba(255,255,255,0.95);
    }
    #alertBox.high { border-color: rgba(239,68,68,0.35); background: rgba(254,242,242,0.95); }
    #alertBox.medium { border-color: rgba(245,158,11,0.35); background: rgba(255,251,235,0.95); }
    #alertBox.info { border-color: rgba(59,130,246,0.35); background: rgba(239,246,255,0.95); }
    #alertBox .aTitle { font-weight: 800; font-size: 12px; margin-bottom: 2px; }
    #alertBox .aText { font-size: 12px; }

    /* Layers panel */
    #layersPanel {
      top: 12px;
      right: 12px;
      width: 280px;
      max-width: calc(100% - 24px);
      padding: 10px 10px 10px 10px;
    }
    #layersPanel .items { display:grid; gap: 8px; margin-top: 8px; }
    .chk { display:flex; align-items:center; justify-content:space-between; gap:10px; font-size: 12px; }
    .chk label { display:flex; align-items:center; gap: 8px; cursor:pointer; }
    .badge { font-size: 11px; color: var(--muted); }

    /* Hotspots panel */
    #hotspotsPanel {
      bottom: 12px;
      right: 12px;
      width: 320px;
      max-width: calc(100% - 24px);
      padding: 10px;
      max-height: 45vh;
      overflow: auto;
    }
    #hotspotsPanel .list { display:grid; gap: 8px; margin-top: 8px; }
    .hotItem {
      border: 1px solid rgba(0,0,0,0.10);
      border-radius: 12px;
      padding: 8px;
      background: rgba(255,255,255,0.95);
      cursor:pointer;
    }
    .hotItem:hover { border-color: rgba(0,0,0,0.18); }
    .hotItem .name { font-weight: 800; font-size: 12px; }
    .hotItem .meta { font-size: 12px; color: var(--muted); margin-top: 2px; }

    /* Mobile tweaks */
    @media (max-width: 900px){
      #sidebar { width: calc(100% - 24px); }
      #layersPanel { width: calc(100% - 24px); top: auto; bottom: 12px; }
      #hotspotsPanel { display:none; }
    }

    a { color: var(--brand); text-decoration: none; }
    a:hover { text-decoration: underline; }

    .pill {
      display:inline-block;
      padding: 2px 8px;
      border: 1px solid rgba(0,0,0,0.10);
      border-radius: 999px;
      font-size: 11px;
      color: var(--muted);
      background: rgba(255,255,255,0.8);
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <!-- Sidebar -->
  <div id="sidebar" class="panel">
    <div class="titlebar">
      <div>
        <div class="title">Közép–Kelet Európa Biztonsági Monitor – helyzetkép</div>
        <div class="small" id="metaLine">Frissítés: —</div>
      </div>
      <button class="btn" id="btnToggleSidebar">Bezár</button>
    </div>

    <div id="alertBox">
      <div class="aTitle" id="alertTitle"></div>
      <div class="aText" id="alertText"></div>
    </div>

    <div class="section">
      <h2 id="dailyHeadline">Napi kivonat</h2>
      <ul id="dailyBullets"><li class="muted">Betöltés…</li></ul>
    </div>

    <div class="hr"></div>

    <div class="section">
      <h2 id="weeklyHeadline">Heti kivonat (7 nap)</h2>
      <ul id="weeklyBullets"><li class="muted">Betöltés…</li></ul>
    </div>

    <div class="hr"></div>

    <div class="section">
      <details>
        <summary style="cursor:pointer; font-weight:800; font-size:12px;">Early signals (elemző mód)</summary>
        <div class="small" style="margin-top:8px;">
          A korai jelzések 48 órás felfutást keresnek (7 napos bázison), rácspont alapú aggregációval.
        </div>
        <div class="small" style="margin-top:8px;">
          Mobilon a “Helyzetkép” aljából csak gomb, hogy ne takarja a térképet.
        </div>
      </details>
    </div>

    <div class="small muted" style="margin-top:10px;">
      Megjegyzés: automatikus OSINT-kivonat; a linkelt források kézi ellenőrzése javasolt.
    </div>
  </div>

  <!-- Layers -->
  <div id="layersPanel" class="panel">
    <div class="row space">
      <div style="font-weight:800; font-size:12px;">Rétegek</div>
      <button class="btn" id="btnToggleLayers">Bezár</button>
    </div>
    <div class="items">
      <div class="chk"><label><input type="checkbox" id="chkBorders" checked/> HATÁR <span class="badge">kontúr</span></label></div>
      <div class="chk"><label><input type="checkbox" id="chkHotspots" checked/> HOTSPOT <span class="badge">heat</span></label></div>
      <div class="chk"><label><input type="checkbox" id="chkEarly"/> EARLY <span class="badge">elemző</span></label></div>
      <div class="chk"><label><input type="checkbox" id="chkGDELT" checked/> GDELT <span class="badge">hírek</span></label></div>
      <div class="chk"><label><input type="checkbox" id="chkUSGS"/> USGS <span class="badge">rengések</span></label></div>
      <div class="chk"><label><input type="checkbox" id="chkGDACS"/> GDACS <span class="badge">riasztás</span></label></div>
    </div>
    <div class="small muted" style="margin-top:10px;">
      Esemény szintek: 0–24h (friss), 1–3 nap, 3–7 nap, 7+ nap (halvány).
    </div>
  </div>

  <!-- Hotspots list -->
  <div id="hotspotsPanel" class="panel">
    <div class="row space">
      <div style="font-weight:800; font-size:12px;">Top hotspotok</div>
      <button class="btn" id="btnToggleHotspots">Bezár</button>
    </div>
    <div class="list" id="hotspotsList">
      <div class="muted small">Betöltés…</div>
    </div>
    <div class="small muted" style="margin-top:8px;">Kattints a sorra → zoom.</div>
  </div>

  <script>
    // ------------------------------
    // Helpers: safe HTML + popup
    // ------------------------------
    function esc(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function popupHtml(p) {
      const title = p.title || p.place || p.name || "Esemény";
      const type  = p.type || p.kind || p.category || "";
      const time  = p.time || p.time_utc || "";
      const src   = p.source || "";
      const url   = p.url || "";

      const extra = [];
      if (p.domain) extra.push(`<span class="pill">${esc(p.domain)}</span>`);
      if (p.language) extra.push(`<span class="pill">${esc(p.language)}</span>`);
      if (p.mag != null) extra.push(`<span class="pill">M ${esc(p.mag)}</span>`);
      if (p.escalation != null) extra.push(`<span class="pill">ES ${esc(p.escalation)}</span>`);
      if (p.score != null) extra.push(`<span class="pill">S ${esc(p.score)}</span>`);

      return `
        <div style="min-width:240px;max-width:360px">
          <div style="font-weight:800;margin-bottom:6px">${esc(title)}</div>
          ${type ? `<div><b>Típus:</b> ${esc(type)}</div>` : ""}
          ${time ? `<div><b>Idő:</b> ${esc(time)}</div>` : ""}
          ${src  ? `<div><b>Forrás:</b> ${esc(src)}</div>` : ""}
          ${extra.length ? `<div style="margin-top:6px;display:flex;flex-wrap:wrap;gap:6px">${extra.join("")}</div>` : ""}
          ${url ? `<div style="margin-top:8px"><a href="${esc(url)}" target="_blank" rel="noopener">Forrás megnyitása</a></div>`
               : `<div style="margin-top:8px"><i>Nincs link az adatban.</i></div>`}
        </div>
      `;
    }

    function ageOpacity(timeIso) {
      // 0–24h: 1.0, 1–3 nap: 0.75, 3–7 nap: 0.55, 7+ nap: 0.35
      if (!timeIso) return 0.75;
      const t = Date.parse(timeIso);
      if (!isFinite(t)) return 0.75;
      const hrs = (Date.now() - t) / 36e5;
      if (hrs <= 24) return 1.0;
      if (hrs <= 72) return 0.75;
      if (hrs <= 168) return 0.55;
      return 0.35;
    }

    async function fetchJson(path) {
      const r = await fetch(path, { cache: "no-store" });
      if (!r.ok) throw new Error(`${path} HTTP ${r.status}`);
      return await r.json();
    }

    // ------------------------------
    // Map init
    // ------------------------------
    const map = L.map("map", { zoomControl: true }).setView([48.5, 19.0], 5);

    const osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 18,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // ------------------------------
    // Layers (GeoJSON)
    // ------------------------------
    const bordersLayer = L.geoJSON(null, {
      style: () => ({ color: "#2563eb", weight: 2, fillOpacity: 0 })
    });

    const gdeltLayer = L.geoJSON(null, {
      pointToLayer: (f, latlng) => {
        const p = f.properties || {};
        const op = ageOpacity(p.time);
        return L.circleMarker(latlng, {
          radius: 6,
          weight: 1,
          color: "#991b1b",
          fillColor: "#ef4444",
          fillOpacity: 0.55 * op
        });
      },
      onEachFeature: (f, layer) => layer.bindPopup(popupHtml(f.properties || {}))
    });

    const usgsLayer = L.geoJSON(null, {
      pointToLayer: (f, latlng) => {
        const p = f.properties || {};
        const op = ageOpacity(p.time);
        return L.circleMarker(latlng, {
          radius: 7,
          weight: 1,
          color: "#0f172a",
          fillColor: "#94a3b8",
          fillOpacity: 0.55 * op
        });
      },
      onEachFeature: (f, layer) => layer.bindPopup(popupHtml(f.properties || {}))
    });

    const gdacsLayer = L.geoJSON(null, {
      pointToLayer: (f, latlng) => {
        const p = f.properties || {};
        const op = ageOpacity(p.time);
        return L.circleMarker(latlng, {
          radius: 7,
          weight: 1,
          color: "#7c2d12",
          fillColor: "#fb923c",
          fillOpacity: 0.55 * op
        });
      },
      onEachFeature: (f, layer) => layer.bindPopup(popupHtml(f.properties || {}))
    });

    const hotspotsLayer = L.geoJSON(null, {
      pointToLayer: (f, latlng) => {
        const p = f.properties || {};
        return L.circleMarker(latlng, {
          radius: 10,
          weight: 1,
          color: "#0f766e",
          fillColor: "#14b8a6",
          fillOpacity: 0.35
        });
      },
      onEachFeature: (f, layer) => {
        const p = f.properties || {};
        const pp = { ...p, title: p.place ? `Hotspot: ${p.place}` : "Hotspot", source: "HOTSPOT" };
        layer.bindPopup(popupHtml(pp));
      }
    });

    const earlyLayer = L.geoJSON(null, {
      pointToLayer: (f, latlng) => {
        const p = f.properties || {};
        // escalation 0..100 -> radius 6..14
        const escv = Math.max(0, Math.min(100, Number(p.escalation ?? 0)));
        const r = 6 + (escv / 100) * 8;
        return L.circleMarker(latlng, {
          radius: r,
          weight: 1,
          color: "#7c3aed",
          fillColor: "#a78bfa",
          fillOpacity: 0.35
        });
      },
      onEachFeature: (f, layer) => {
        const p = f.properties || {};
        const pp = { ...p, title: p.place ? `Early: ${p.place}` : "Early signal", source: "EARLY" };
        layer.bindPopup(popupHtml(pp));
      }
    });

    // Default visible layers
    bordersLayer.addTo(map);
    hotspotsLayer.addTo(map);
    gdeltLayer.addTo(map);
    // USGS/GDACS/EARLY default off to avoid clutter

    // ------------------------------
    // UI toggles
    // ------------------------------
    function setVisible(layer, on) {
      if (on) layer.addTo(map); else map.removeLayer(layer);
    }

    document.getElementById("chkBorders").addEventListener("change", e => setVisible(bordersLayer, e.target.checked));
    document.getElementById("chkHotspots").addEventListener("change", e => setVisible(hotspotsLayer, e.target.checked));
    document.getElementById("chkEarly").addEventListener("change", e => setVisible(earlyLayer, e.target.checked));
    document.getElementById("chkGDELT").addEventListener("change", e => setVisible(gdeltLayer, e.target.checked));
    document.getElementById("chkUSGS").addEventListener("change", e => setVisible(usgsLayer, e.target.checked));
    document.getElementById("chkGDACS").addEventListener("change", e => setVisible(gdacsLayer, e.target.checked));

    function togglePanel(id, btnId) {
      const el = document.getElementById(id);
      const btn = document.getElementById(btnId);
      let open = true;
      btn.addEventListener("click", () => {
        open = !open;
        if (open) {
          el.style.display = "";
          btn.textContent = "Bezár";
        } else {
          el.style.display = "none";
          btn.textContent = "Kinyit";
        }
      });
    }
    togglePanel("sidebar", "btnToggleSidebar");
    togglePanel("layersPanel", "btnToggleLayers");
    togglePanel("hotspotsPanel", "btnToggleHotspots");

    // ------------------------------
    // Data loaders
    // ------------------------------
    async function loadBorders() {
      try {
        const j = await fetchJson("data/cee_borders.geojson");
        bordersLayer.clearLayers().addData(j);
      } catch (e) {
        console.warn("Borders load failed:", e);
      }
    }

    async function loadLayer(path, layer) {
      try {
        const j = await fetchJson(path);
        layer.clearLayers().addData(j);
      } catch (e) {
        console.warn(path, "load failed:", e);
        layer.clearLayers();
      }
    }

    async function loadMetaAndSummaries() {
      try {
        const meta = await fetchJson("data/meta.json");
        document.getElementById("metaLine").textContent =
          `Frissítés: ${meta.generated_utc || "—"} | hotspot cellák: ${meta.counts?.hotspot_cells ?? 0} | GDELT: ${meta.counts?.gdelt ?? 0} | USGS: ${meta.counts?.usgs ?? 0} | GDACS: ${meta.counts?.gdacs ?? 0}`;
      } catch (e) {
        document.getElementById("metaLine").textContent = "Frissítés: nem sikerült.";
      }

      // Daily
      try {
        const daily = await fetchJson("data/summary.json");
        document.getElementById("dailyHeadline").textContent = daily.headline || "Napi kivonat";
        const ul = document.getElementById("dailyBullets");
        ul.innerHTML = "";
        (daily.bullets || []).forEach(b => {
          const li = document.createElement("li");
          li.textContent = b;
          ul.appendChild(li);
        });

        // alert
        const a = daily.alert;
        const box = document.getElementById("alertBox");
        if (a && a.text) {
          box.className = "panel";
          box.id = "alertBox";
          box.style.display = "";
          box.classList.add(a.level || "info");
          document.getElementById("alertTitle").textContent = a.title || "Riasztás";
          document.getElementById("alertText").textContent = a.text || "";
        } else {
          box.style.display = "none";
        }
      } catch (e) {
        const ul = document.getElementById("dailyBullets");
        ul.innerHTML = `<li class="muted">Nincs elérhető kivonat.</li>`;
      }

      // Weekly
      try {
        const weekly = await fetchJson("data/weekly.json");
        document.getElementById("weeklyHeadline").textContent = weekly.headline || "Heti kivonat – elmúlt 7 nap";
        const ul = document.getElementById("weeklyBullets");
        ul.innerHTML = "";
        (weekly.bullets || []).forEach(b => {
          const li = document.createElement("li");
          li.textContent = b;
          ul.appendChild(li);
        });
      } catch (e) {
        const ul = document.getElementById("weeklyBullets");
        ul.innerHTML = `<li class="muted">A heti kivonat még gyűlik.</li>`;
      }
    }

    async function loadHotspotsList() {
      const list = document.getElementById("hotspotsList");
      list.innerHTML = `<div class="muted small">Betöltés…</div>`;
      try {
        const j = await fetchJson("data/hotspots.json");
        const top = j.top || [];
        if (!top.length) {
          list.innerHTML = `<div class="muted small">Nincs elég adat.</div>`;
          return;
        }
        list.innerHTML = "";
        top.slice(0, 10).forEach((h, idx) => {
          const div = document.createElement("div");
          div.className = "hotItem";
          const name = h.place || `Hotspot #${idx+1}`;
          const score = h.score != null ? Number(h.score).toFixed(2) : "—";
          const arrow = h.trend_arrow || "";
          const ch = (h.change_pct == null) ? "n/a" : `${h.change_pct > 0 ? "+" : ""}${h.change_pct}%`;
          div.innerHTML = `
            <div class="name">${esc(name)} <span class="muted">${esc(arrow)}</span></div>
            <div class="meta">(${h.lat?.toFixed?.(2) ?? h.lat}, ${h.lon?.toFixed?.(2) ?? h.lon}) · score: ${esc(score)} · 7 nap: ${esc(ch)}</div>
          `;
          div.addEventListener("click", () => {
            const lat = Number(h.lat), lon = Number(h.lon);
            if (isFinite(lat) && isFinite(lon)) map.setView([lat, lon], 8);
          });
          list.appendChild(div);
        });
      } catch (e) {
        list.innerHTML = `<div class="muted small">Nem sikerült betölteni a hotspot listát.</div>`;
      }
    }

    // ------------------------------
    // Boot
    // ------------------------------
    (async function boot(){
      await loadBorders();

      // Layers (files created by scripts/update_data.py)
      await loadLayer("data/gdelt.geojson", gdeltLayer);
      await loadLayer("data/usgs.geojson", usgsLayer);
      await loadLayer("data/gdacs.geojson", gdacsLayer);
      await loadLayer("data/hotspots.geojson", hotspotsLayer);
      await loadLayer("data/early.geojson", earlyLayer);

      await loadMetaAndSummaries();
      await loadHotspotsList();

      // Optional: fit to borders once
      try {
        const b = bordersLayer.getBounds();
        if (b.isValid()) map.fitBounds(b.pad(0.05));
      } catch {}
    })();
  </script>
</body>
</html>
