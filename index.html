<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Közép–Kelet Európa Biztonsági Monitor</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #map { height: 100%; width: 100%; }

    .panel {
      position: absolute;
      top: 12px;
      left: 12px;
      z-index: 999;
      background: rgba(255,255,255,0.95);
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      padding: 12px 12px;
      max-width: 420px;
      width: 360px;
    }
    .panel h1 { font-size: 16px; margin: 0 0 6px; }
    .panel .meta { font-size: 12px; color: #444; margin-bottom: 10px; }
    .row { display: flex; gap: 8px; align-items: center; margin: 6px 0; }
    .row label { font-size: 13px; }
    .small { font-size: 12px; color: #666; }
    .status { margin-top: 8px; font-size: 12px; color: #333; }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      background: #eef2ff;
      color: #1e3a8a;
      margin-left: 6px;
    }

    /* Popup */
    .popup-title { font-weight: 700; margin-bottom: 6px; }
    .popup-line { margin: 2px 0; }
    .popup-link a { text-decoration: none; }
    .popup-link a:hover { text-decoration: underline; }
  </style>
</head>

<body>
  <div id="map"></div>

  <div class="panel">
    <h1>Közép–Kelet Európa Biztonsági Monitor</h1>
    <div class="meta">
      Források: GDELT (hírek), USGS (rengések), GDACS (riasztások) · Rétegek kapcsolhatóak
    </div>

    <div class="row">
      <input type="checkbox" id="layer-borders" checked />
      <label for="layer-borders">Országhatárok</label>
    </div>

    <div class="row">
      <input type="checkbox" id="layer-gdelt" checked />
      <label for="layer-gdelt">GDELT hírek</label>
      <span class="badge" id="count-gdelt">0</span>
    </div>

    <div class="row">
      <input type="checkbox" id="layer-usgs" />
      <label for="layer-usgs">USGS rengések</label>
      <span class="badge" id="count-usgs">0</span>
    </div>

    <div class="row">
      <input type="checkbox" id="layer-gdacs" />
      <label for="layer-gdacs">GDACS riasztások</label>
      <span class="badge" id="count-gdacs">0</span>
    </div>

    <div class="row">
      <input type="checkbox" id="layer-hotspots" />
      <label for="layer-hotspots">Hotspot rács</label>
      <span class="badge" id="count-hotspots">0</span>
    </div>

    <div class="small">
      Tipp: kattints egy pontra a részletekért és a forrás linkért.
    </div>

    <div class="status" id="status">Betöltés…</div>
  </div>

  <script>
    // ---------------------------
    // Map init
    // ---------------------------
    const map = L.map('map', { zoomControl: true });

    // CEE nézet (kb.)
    map.setView([50.5, 19.5], 5);

    // Base layers
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // ---------------------------
    // Popup renderer
    // ---------------------------
    function escapeHtml(s) {
      return String(s || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function popupHtml(p) {
      const title = p.title || p.place || p.name || "Esemény";
      const category = p.category || p.kind || p.type || "";
      const time = p.time || p.time_utc || "";
      const src = p.source || "";
      const domain = p.domain || "";
      const url = p.url || "";

      const lines = [];

      if (category) lines.push(`<div class="popup-line"><b>Típus:</b> ${escapeHtml(category)}</div>`);
      if (time) lines.push(`<div class="popup-line"><b>Idő:</b> ${escapeHtml(time)}</div>`);
      if (src) lines.push(`<div class="popup-line"><b>Forrás:</b> ${escapeHtml(src)}${domain ? " ("+escapeHtml(domain)+")" : ""}</div>`);

      if (url) {
        const safe = escapeHtml(url);
        lines.push(`<div class="popup-line popup-link"><a href="${safe}" target="_blank" rel="noopener">Forrás megnyitása</a></div>`);
      } else {
        lines.push(`<div class="popup-line"><i>Nincs link az adatban.</i></div>`);
      }

      return `
        <div style="min-width:240px;max-width:340px">
          <div class="popup-title">${escapeHtml(title)}</div>
          ${lines.join("")}
        </div>
      `;
    }

    // ---------------------------
    // Styles
    // ---------------------------
    function pointStyleGDELT(feature) {
      return {
        radius: 6,
        weight: 1,
        color: "#b91c1c",
        fillColor: "#ef4444",
        fillOpacity: 0.55
      };
    }

    function pointStyleUSGS(feature) {
      const mag = Number(feature?.properties?.mag || 0);
      const r = Math.max(5, Math.min(14, 4 + mag * 2));
      return {
        radius: r,
        weight: 1,
        color: "#1e40af",
        fillColor: "#3b82f6",
        fillOpacity: 0.45
      };
    }

    function pointStyleGDACS(feature) {
      return {
        radius: 7,
        weight: 1,
        color: "#92400e",
        fillColor: "#f59e0b",
        fillOpacity: 0.5
      };
    }

    function hotspotStyle(feature) {
      const s = Number(feature?.properties?.score || 0);
      // score alapján átlátszóság
      const opacity = Math.max(0.15, Math.min(0.75, 0.2 + s));
      return {
        radius: 10,
        weight: 1,
        color: "#0f766e",
        fillColor: "#14b8a6",
        fillOpacity: opacity
      };
    }

    function borderStyle(feature) {
      return {
        weight: 2,
        color: "#1d4ed8",
        opacity: 0.8,
        fillOpacity: 0.0
      };
    }

    // ---------------------------
    // Layer holders
    // ---------------------------
    const layers = {
      borders: L.geoJSON(null, { style: borderStyle }),
      gdelt: L.geoJSON(null, {
        pointToLayer: (feature, latlng) => L.circleMarker(latlng, pointStyleGDELT(feature)),
        onEachFeature: (feature, layer) => layer.bindPopup(popupHtml(feature.properties || {}))
      }),
      usgs: L.geoJSON(null, {
        pointToLayer: (feature, latlng) => L.circleMarker(latlng, pointStyleUSGS(feature)),
        onEachFeature: (feature, layer) => layer.bindPopup(popupHtml(feature.properties || {}))
      }),
      gdacs: L.geoJSON(null, {
        pointToLayer: (feature, latlng) => L.circleMarker(latlng, pointStyleGDACS(feature)),
        onEachFeature: (feature, layer) => layer.bindPopup(popupHtml(feature.properties || {}))
      }),
      hotspots: L.geoJSON(null, {
        pointToLayer: (feature, latlng) => L.circleMarker(latlng, hotspotStyle(feature)),
        onEachFeature: (feature, layer) => layer.bindPopup(popupHtml(feature.properties || {}))
      })
    };

    // Add defaults
    layers.borders.addTo(map);
    layers.gdelt.addTo(map);

    // ---------------------------
    // Fetch helpers
    // ---------------------------
    async function fetchJson(url) {
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`${url} -> HTTP ${res.status}`);
      return await res.json();
    }

    function setCount(id, n) {
      const el = document.getElementById(id);
      if (el) el.textContent = String(n || 0);
    }

    function setStatus(msg) {
      document.getElementById("status").textContent = msg;
    }

    // ---------------------------
    // Load all data
    // ---------------------------
    async function loadAll() {
      setStatus("Rétegek betöltése…");

      // Borders
      try {
        const borders = await fetchJson("data/cee_borders.geojson");
        layers.borders.clearLayers().addData(borders);
      } catch (e) {
        console.warn("Borders load failed", e);
      }

      // GDELT
      try {
        const gdelt = await fetchJson("data/gdelt.geojson");
        layers.gdelt.clearLayers().addData(gdelt);
        setCount("count-gdelt", (gdelt.features || []).length);
      } catch (e) {
        console.warn("GDELT load failed", e);
        setCount("count-gdelt", 0);
      }

      // USGS
      try {
        const usgs = await fetchJson("data/usgs.geojson");
        layers.usgs.clearLayers().addData(usgs);
        setCount("count-usgs", (usgs.features || []).length);
      } catch (e) {
        console.warn("USGS load failed", e);
        setCount("count-usgs", 0);
      }

      // GDACS
      try {
        const gdacs = await fetchJson("data/gdacs.geojson");
        layers.gdacs.clearLayers().addData(gdacs);
        setCount("count-gdacs", (gdacs.features || []).length);
      } catch (e) {
        console.warn("GDACS load failed", e);
        setCount("count-gdacs", 0);
      }

      // Hotspots
      try {
        const hotspots = await fetchJson("data/hotspots.geojson");
        layers.hotspots.clearLayers().addData(hotspots);
        setCount("count-hotspots", (hotspots.features || []).length);
      } catch (e) {
        console.warn("Hotspots load failed", e);
        setCount("count-hotspots", 0);
      }

      setStatus("Kész. Kattints a pontokra a részletekért.");
    }

    // ---------------------------
    // UI toggles
    // ---------------------------
    function bindToggle(id, layerKey) {
      const el = document.getElementById(id);
      if (!el) return;

      el.addEventListener("change", () => {
        if (el.checked) layers[layerKey].addTo(map);
        else map.removeLayer(layers[layerKey]);
      });
    }

    bindToggle("layer-borders", "borders");
    bindToggle("layer-gdelt", "gdelt");
    bindToggle("layer-usgs", "usgs");
    bindToggle("layer-gdacs", "gdacs");
    bindToggle("layer-hotspots", "hotspots");

    // Start
    loadAll();
  </script>
</body>
</html>
