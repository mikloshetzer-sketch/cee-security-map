<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Közép–Kelet Európa Biztonsági Monitor</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root{
      --bg: rgba(255,255,255,.92);
      --bg2: rgba(255,255,255,.96);
      --bd: rgba(0,0,0,.12);
      --txt: #111827;
      --muted:#6b7280;
      --chip:#ffffff;
      --chipbd: rgba(0,0,0,.18);
      --shadow: 0 10px 30px rgba(0,0,0,.18);
      --shadow2: 0 6px 18px rgba(0,0,0,.14);
      --radius: 14px;
      --radius2: 12px;
      --pad: 12px;
      --z: 9999;
      --accent: #2563eb;
      --danger: #b91c1c;
      --warn: #b45309;
      --ok: #047857;
    }

    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color: var(--txt); }
    #map { height: 100%; width: 100%; }

    /* --- Floating "chip" buttons (panel openers) --- */
    .chipbar{
      position: absolute;
      z-index: var(--z);
      left: 10px;
      top: 84px; /* lejjebb a zoom +/− gombtól */
      display: flex;
      flex-direction: column;
      gap: 8px;
      pointer-events: none;
    }
    .chipbar .chip{
      pointer-events: auto;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: var(--chip);
      border: 1px solid var(--chipbd);
      box-shadow: var(--shadow2);
      font-size: 13px;
      cursor: pointer;
      user-select: none;
      max-width: 220px;
    }
    .chipbar .chip strong{ font-weight: 650; }
    .chipbar .chip .dot{
      width: 8px; height: 8px; border-radius: 999px; background: var(--accent);
    }

    /* --- Panels --- */
    .panel{
      position: absolute;
      z-index: calc(var(--z) - 1);
      background: var(--bg);
      border: 1px solid var(--bd);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      display: none; /* default zárva */
      max-height: 78vh;
    }
    .panel.open{ display: block; }

    .panel .ph{
      display:flex; align-items:center; justify-content:space-between;
      padding: 10px 12px;
      background: var(--bg2);
      border-bottom: 1px solid var(--bd);
      gap: 10px;
    }
    .panel .ph .title{
      font-weight: 700;
      font-size: 14px;
      display:flex;
      align-items:center;
      gap: 8px;
      min-width: 0;
    }
    .panel .ph .title span{
      color: var(--muted);
      font-weight: 600;
      font-size: 12px;
      white-space: nowrap;
    }
    .panel .ph .btns{ display:flex; gap: 8px; }
    .panel button{
      border: 1px solid var(--bd);
      background: white;
      border-radius: 10px;
      padding: 6px 10px;
      font-size: 12px;
      cursor:pointer;
    }
    .panel button.primary{
      border-color: rgba(37,99,235,.35);
      background: rgba(37,99,235,.08);
    }

    .panel .pc{
      padding: 10px 12px;
      overflow:auto;
      max-height: calc(78vh - 46px);
      font-size: 13px;
      line-height: 1.35;
    }
    .muted{ color: var(--muted); }

    /* Positions */
    #panelSummary{ left: 10px; top: 132px; width: min(420px, calc(100vw - 20px)); }
    #panelLayers{ right: 10px; top: 84px; width: min(320px, calc(100vw - 20px)); }
    #panelHotspots{ right: 10px; bottom: 120px; width: min(320px, calc(100vw - 20px)); }
    #panelLegend{ right: 10px; bottom: 10px; width: min(280px, calc(100vw - 20px)); } /* keskenyebb */
    #panelLegend .pc{ font-size: 12.5px; }

    /* Alert bar (top, full width) */
    #alertbar{
      position:absolute; z-index: var(--z);
      left:0; right:0; top:0;
      padding: 8px 10px;
      display:none;
      align-items:center;
      gap:10px;
      background: rgba(255,255,255,.95);
      border-bottom: 1px solid var(--bd);
      box-shadow: 0 6px 16px rgba(0,0,0,.08);
    }
    #alertbar.open{ display:flex; }
    #alertbadge{
      font-weight: 800;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--bd);
      background: rgba(0,0,0,.04);
      white-space: nowrap;
    }
    #alerttext{ font-size: 13px; }
    #alertclose{ margin-left:auto; }

    /* Accordion in summary */
    .acc{
      border: 1px solid rgba(0,0,0,.10);
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 10px;
      background: rgba(255,255,255,.7);
    }
    .acc .ah{
      display:flex; align-items:center; justify-content:space-between;
      padding: 8px 10px;
      cursor:pointer;
      user-select:none;
      background: rgba(255,255,255,.85);
      border-bottom: 1px solid rgba(0,0,0,.08);
      font-weight: 700;
      font-size: 13px;
    }
    .acc .ah small{ font-weight:600; color: var(--muted); }
    .acc .ab{ display:none; padding: 8px 10px; }
    .acc.open .ab{ display:block; }
    .acc .ab ul{ margin: 6px 0 0 18px; padding:0; }
    .acc .ab li{ margin: 4px 0; }
    .pillrow{ display:flex; flex-wrap:wrap; gap:8px; margin-top: 10px; }
    .pill{
      border: 1px solid rgba(0,0,0,.12);
      background: white;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      cursor:pointer;
      user-select:none;
    }
    .pill.active{ border-color: rgba(37,99,235,.35); background: rgba(37,99,235,.08); }
    .hr{ height:1px; background: rgba(0,0,0,.08); margin: 10px 0; }

    /* Layer list */
    .layerline{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding: 6px 0; }
    .layerline label{ display:flex; align-items:center; gap:8px; cursor:pointer; }
    .layerline input{ transform: translateY(1px); }
    .hint{ font-size: 12px; color: var(--muted); }

    /* Hotspot list */
    .hsitem{
      padding: 8px 10px;
      border: 1px solid rgba(0,0,0,.10);
      border-radius: 12px;
      background: rgba(255,255,255,.8);
      margin-bottom: 8px;
      cursor:pointer;
    }
    .hsitem .t{ font-weight: 750; font-size: 13px; }
    .hsitem .m{ color: var(--muted); font-size: 12px; margin-top: 2px; display:flex; gap:10px; flex-wrap:wrap; }
    .tiny{ font-size: 11px; color: var(--muted); }

    /* Popup link */
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }

    /* Mobile tweaks */
    @media (max-width: 520px){
      .chipbar{ top: 96px; left: 10px; }
      #panelSummary{ top: 146px; }
      #panelLayers{ top: 96px; }
      #panelHotspots{ bottom: 110px; }
      #panelLegend{ width: min(240px, calc(100vw - 20px)); } /* még keskenyebb */
      /* Leaflet zoom position is top-left; we already lowered chips. */
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <!-- Alert bar -->
  <div id="alertbar" role="status" aria-live="polite">
    <span id="alertbadge">RIASZTÁS</span>
    <span id="alerttext"></span>
    <button id="alertclose" class="primary">Bezár</button>
  </div>

  <!-- Panel openers -->
  <div class="chipbar" aria-label="Panelek megnyitása">
    <div class="chip" id="btnOpenSummary"><span class="dot"></span><strong>Kivonat</strong> <span class="muted">napi/heti/early</span></div>
    <div class="chip" id="btnOpenHotspots"><span class="dot" style="background:#dc2626"></span><strong>Hotspotok</strong> <span class="muted">top lista</span></div>
    <div class="chip" id="btnOpenLayers"><span class="dot" style="background:#111827"></span><strong>Rétegek</strong> <span class="muted">kapcsolók</span></div>
    <div class="chip" id="btnOpenLegend"><span class="dot" style="background:#059669"></span><strong>Jelmagyarázat</strong> <span class="muted">színek</span></div>
  </div>

  <!-- Summary panel -->
  <div class="panel" id="panelSummary">
    <div class="ph">
      <div class="title">Közép–Kelet Európa Biztonsági Monitor <span id="metaLine">—</span></div>
      <div class="btns">
        <button id="btnCloseSummary">Bezár</button>
      </div>
    </div>
    <div class="pc">
      <div class="pillrow" style="margin-top:0">
        <div class="pill active" id="btnFilterAll">Összes (7 nap)</div>
        <div class="pill" id="btnFilterToday">Mai események</div>
      </div>

      <div class="hr"></div>

      <div class="acc" id="accDaily">
        <div class="ah">
          <div>▸ Napi kivonat</div>
          <small id="dailyTime">—</small>
        </div>
        <div class="ab">
          <div id="dailyBullets" class="muted">Nincs adat.</div>
        </div>
      </div>

      <div class="acc" id="accWeekly">
        <div class="ah">
          <div>▸ Heti kivonat (7 nap)</div>
          <small id="weeklyTime">—</small>
        </div>
        <div class="ab">
          <div id="weeklyBullets" class="muted">Nincs adat.</div>
        </div>
      </div>

      <div class="acc" id="accEarly">
        <div class="ah">
          <div>▸ Early signals (elemző mód)</div>
          <small id="earlyTime">—</small>
        </div>
        <div class="ab">
          <div class="muted">
            Az “EARLY” réteg a friss (pl. 48 órás) jelzéseket és a bázishoz képesti felfutást emeli ki.
          </div>
        </div>
      </div>

      <div class="tiny">
        Mobilon a panelek alapból zárva vannak; a bal felső gombokkal nyithatók.
      </div>
    </div>
  </div>

  <!-- Layers panel -->
  <div class="panel" id="panelLayers">
    <div class="ph">
      <div class="title">Rétegek <span class="muted">kapcsolók</span></div>
      <div class="btns">
        <button id="btnCloseLayers">Bezár</button>
      </div>
    </div>
    <div class="pc">
      <div class="layerline">
        <label><input type="checkbox" id="chkBorders" checked /> HATÁR <span class="muted">kontúr</span></label>
      </div>
      <div class="layerline">
        <label><input type="checkbox" id="chkHotspots" checked /> HOTSPOT <span class="muted">heat</span></label>
      </div>
      <div class="layerline">
        <label><input type="checkbox" id="chkEarly" checked /> EARLY <span class="muted">elemző</span></label>
      </div>
      <div class="layerline">
        <label><input type="checkbox" id="chkGdelt" checked /> GDELT <span class="muted">hírek</span></label>
      </div>
      <div class="layerline">
        <label><input type="checkbox" id="chkUsgs" checked /> USGS <span class="muted">rengések</span></label>
      </div>
      <div class="layerline">
        <label><input type="checkbox" id="chkGdacs" checked /> GDACS <span class="muted">riasztás</span></label>
      </div>

      <div class="hr"></div>
      <div class="hint" id="layerHint">Események színezése: idősáv + kategória. Link a buborékban, ha az adatban van `url`.</div>
    </div>
  </div>

  <!-- Hotspots panel -->
  <div class="panel" id="panelHotspots">
    <div class="ph">
      <div class="title">Top hotspotok <span class="muted" id="hsGen">—</span></div>
      <div class="btns">
        <button id="btnCloseHotspots">Bezár</button>
      </div>
    </div>
    <div class="pc">
      <div id="hotspotList" class="muted">Nincs elég adat.</div>
      <div class="tiny">Kattints a sorra → zoom a rácspontra.</div>
    </div>
  </div>

  <!-- Legend panel -->
  <div class="panel" id="panelLegend">
    <div class="ph">
      <div class="title">Jelmagyarázat</div>
      <div class="btns">
        <button id="btnCloseLegend">Bezár</button>
      </div>
    </div>
    <div class="pc">
      <div style="font-weight:750; margin-bottom:6px;">Idősáv (GDELT)</div>
      <div class="muted" style="display:grid; gap:6px; grid-template-columns: 1fr;">
        <div>● <span style="color:#dc2626;font-weight:700;">0–24 óra</span></div>
        <div>● <span style="color:#f59e0b;font-weight:700;">1–3 nap</span></div>
        <div>● <span style="color:#10b981;font-weight:700;">3–7 nap</span></div>
      </div>

      <div class="hr"></div>

      <div style="font-weight:750; margin-bottom:6px;">Kategória (GDELT)</div>
      <div class="muted" style="display:grid; gap:6px; grid-template-columns: 1fr;">
        <div><span style="display:inline-block;width:10px;height:10px;border-radius:999px;background:#2563eb;margin-right:8px"></span>Kiber / dezinformáció</div>
        <div><span style="display:inline-block;width:10px;height:10px;border-radius:999px;background:#7c3aed;margin-right:8px"></span>Energia / infrastruktúra</div>
        <div><span style="display:inline-block;width:10px;height:10px;border-radius:999px;background:#059669;margin-right:8px"></span>Határ / migráció</div>
        <div><span style="display:inline-block;width:10px;height:10px;border-radius:999px;background:#ea580c;margin-right:8px"></span>Tüntetés / zavargás</div>
        <div><span style="display:inline-block;width:10px;height:10px;border-radius:999px;background:#111827;margin-right:8px"></span>Katonai / biztonságpolitika</div>
        <div><span style="display:inline-block;width:10px;height:10px;border-radius:999px;background:#6b7280;margin-right:8px"></span>Egyéb</div>
      </div>

      <div class="hr"></div>
      <div class="tiny">USGS/GDACS saját színezést használ (természeti/riasztási jelleg).</div>
    </div>
  </div>

<script>
(() => {
  // -----------------------------
  // Helpers
  // -----------------------------
  const el = (id) => document.getElementById(id);
  const show = (id, yes=true) => { const p = el(id); if(!p) return; p.classList.toggle('open', !!yes); };
  const isOpen = (id) => el(id)?.classList.contains('open');

  function fmtUtc(iso){
    if(!iso) return '—';
    try{
      const d = new Date(iso);
      return d.toISOString().replace('T',' ').replace('Z',' UTC');
    }catch{ return '—'; }
  }

  function fmtLocalBudapest(iso){
    // Budapest local time display (best-effort without external libs)
    if(!iso) return '—';
    try{
      const d = new Date(iso);
      return new Intl.DateTimeFormat('hu-HU', {
        timeZone: 'Europe/Budapest',
        year:'numeric', month:'2-digit', day:'2-digit',
        hour:'2-digit', minute:'2-digit'
      }).format(d);
    }catch{ return '—'; }
  }

  function toBudapestDateKey(dateObj){
    // YYYY-MM-DD in Europe/Budapest
    try{
      const s = new Intl.DateTimeFormat('en-CA', { timeZone:'Europe/Budapest', year:'numeric', month:'2-digit', day:'2-digit' }).format(dateObj);
      return s; // en-CA gives YYYY-MM-DD
    }catch{
      const y = dateObj.getUTCFullYear();
      const m = String(dateObj.getUTCMonth()+1).padStart(2,'0');
      const d = String(dateObj.getUTCDate()).padStart(2,'0');
      return `${y}-${m}-${d}`;
    }
  }

  function safeText(x){ return (x === null || x === undefined) ? '' : String(x); }

  function escapeHtml(str){
    return String(str || '').replace(/[&<>"']/g, (m) => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
    }[m]));
  }

  async function fetchJson(url){
    const r = await fetch(url, { cache: 'no-store' });
    if(!r.ok) throw new Error(`HTTP ${r.status} ${url}`);
    return await r.json();
  }

  // -----------------------------
  // Map init
  // -----------------------------
  const map = L.map('map', { zoomControl:true, preferCanvas:true });

  const base = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  // Default view roughly on CEE
  map.setView([49.5, 20.5], 5);

  // -----------------------------
  // Category palette for GDELT
  // -----------------------------
  const CAT_COLORS = {
    cyber: '#2563eb',
    energy: '#7c3aed',
    border: '#059669',
    protest: '#ea580c',
    military: '#111827',
    other: '#6b7280'
  };

  function classifyGdelt(props){
    // 1) if script already writes category, use it
    const c = (props.category || props.cat || '').toString().toLowerCase().trim();
    if(c) return c;

    // 2) fallback from title keywords
    const t = (props.title || '').toString().toLowerCase();
    if(/cyber|ransomware|ddos|hack|phish|disinfo|disinformation/.test(t)) return 'cyber';
    if(/pipeline|power|outage|energy|gas|electric|substation|grid|infrastructure/.test(t)) return 'energy';
    if(/border|checkpoint|incursion|smuggl|migrant|migration/.test(t)) return 'border';
    if(/protest|demonstration|strike|riot|clash/.test(t)) return 'protest';
    if(/military|troop|deployment|exercise|drone|security|defen[cs]e/.test(t)) return 'military';
    return 'other';
  }

  function ageBucketColor(props){
    // Age buckets for GDELT: 0-24h red, 1-3d orange, 3-7d green
    const iso = props.time || props.seendate || props.date || props.datetime;
    if(!iso) return '#6b7280';
    const dt = new Date(iso);
    const hours = (Date.now() - dt.getTime()) / 3600000;
    if(hours <= 24) return '#dc2626';
    if(hours <= 72) return '#f59e0b';
    return '#10b981';
  }

  function gdeltStyle(props){
    const cat = classifyGdelt(props);
    const catColor = CAT_COLORS[cat] || CAT_COLORS.other;
    const ageColor = ageBucketColor(props);

    // ring: age, fill: category
    return {
      radius: 7,
      color: ageColor,
      weight: 2,
      fillColor: catColor,
      fillOpacity: 0.55
    };
  }

  function usgsStyle(props){
    const mag = Number(props.mag || 0);
    const r = Math.max(6, Math.min(18, 6 + mag * 2));
    return { radius:r, color:'#0f172a', weight:2, fillColor:'#0ea5e9', fillOpacity:0.45 };
  }

  function gdacsStyle(props){
    return { radius: 9, color:'#7c2d12', weight:2, fillColor:'#f97316', fillOpacity:0.45 };
  }

  function hotspotStyle(props){
    const s = Number(props.score || 0);
    const r = Math.max(10, Math.min(28, 10 + s * 10));
    return { radius:r, color:'#991b1b', weight:2, fillColor:'#60a5fa', fillOpacity:0.35 };
  }

  function earlyStyle(props){
    const e = Number(props.escalation || 0);
    const r = Math.max(10, Math.min(26, 10 + e/6));
    return { radius:r, color:'#111827', weight:2, fillColor:'#a78bfa', fillOpacity:0.35 };
  }

  function popupHtml(props){
    const title = escapeHtml(props.title || props.place || props.location || 'Esemény');
    const source = escapeHtml(props.source || '—');
    const time = props.time ? fmtLocalBudapest(props.time) : (props.date ? escapeHtml(props.date) : '—');
    const cat = escapeHtml((props.category || classifyGdelt(props) || props.kind || props.type || '—'));

    const url = props.url || props.sourceurl || (props.sources && props.sources[0]) || null;
    const link = url ? `<a href="${escapeHtml(url)}" target="_blank" rel="noopener">Forrás megnyitása</a>` : `<span class="muted">Nincs link az adatban.</span>`;

    const domain = props.domain ? ` <span class="muted">(${escapeHtml(props.domain)})</span>` : '';

    return `
      <div style="min-width:220px;max-width:300px">
        <div style="font-weight:800;margin-bottom:6px">${title}${domain}</div>
        <div style="display:grid;gap:4px">
          <div><span class="muted">Idő:</span> ${escapeHtml(time)}</div>
          <div><span class="muted">Kategória:</span> ${cat}</div>
          <div><span class="muted">Forrás:</span> ${source}</div>
          <div style="margin-top:6px">${link}</div>
        </div>
      </div>
    `;
  }

  // -----------------------------
  // Layers (Leaflet)
  // -----------------------------
  let layerBorders = L.geoJSON(null, {
    style: { color:'#2563eb', weight:2, fillOpacity:0 }
  });

  let layerGdelt = L.geoJSON(null, {
    pointToLayer: (f, latlng) => L.circleMarker(latlng, gdeltStyle(f.properties || {})),
    onEachFeature: (f, lyr) => lyr.bindPopup(popupHtml(f.properties || {}))
  });

  let layerUsgs = L.geoJSON(null, {
    pointToLayer: (f, latlng) => L.circleMarker(latlng, usgsStyle(f.properties || {})),
    onEachFeature: (f, lyr) => lyr.bindPopup(popupHtml(f.properties || {}))
  });

  let layerGdacs = L.geoJSON(null, {
    pointToLayer: (f, latlng) => L.circleMarker(latlng, gdacsStyle(f.properties || {})),
    onEachFeature: (f, lyr) => lyr.bindPopup(popupHtml(f.properties || {}))
  });

  let layerHotspots = L.geoJSON(null, {
    pointToLayer: (f, latlng) => L.circleMarker(latlng, hotspotStyle(f.properties || {})),
    onEachFeature: (f, lyr) => lyr.bindPopup(popupHtml({ ...f.properties, title: (f.properties?.place || 'Hotspot'), source:'Hotspot' }))
  });

  let layerEarly = L.geoJSON(null, {
    pointToLayer: (f, latlng) => L.circleMarker(latlng, earlyStyle(f.properties || {})),
    onEachFeature: (f, lyr) => lyr.bindPopup(popupHtml({ ...f.properties, title: (f.properties?.place || 'Early signal'), source:'Early' }))
  });

  // Add all by default (you can toggle via panel)
  layerBorders.addTo(map);
  layerHotspots.addTo(map);
  layerEarly.addTo(map);
  layerGdelt.addTo(map);
  layerUsgs.addTo(map);
  layerGdacs.addTo(map);

  // -----------------------------
  // Panel open/close wiring (important: close = hide, NOT destroy)
  // -----------------------------
  el('btnOpenSummary').onclick = () => show('panelSummary', true);
  el('btnOpenLayers').onclick = () => show('panelLayers', true);
  el('btnOpenHotspots').onclick = () => show('panelHotspots', true);
  el('btnOpenLegend').onclick = () => show('panelLegend', true);

  el('btnCloseSummary').onclick = () => show('panelSummary', false);
  el('btnCloseLayers').onclick = () => show('panelLayers', false);
  el('btnCloseHotspots').onclick = () => show('panelHotspots', false);
  el('btnCloseLegend').onclick = () => show('panelLegend', false);

  // Accordions
  function bindAcc(id){
    const a = el(id);
    if(!a) return;
    const h = a.querySelector('.ah');
    h.addEventListener('click', () => {
      a.classList.toggle('open');
      // arrow
      const left = h.querySelector('div');
      if(left) left.textContent = (a.classList.contains('open') ? '▾ ' : '▸ ') + left.textContent.replace(/^▾\s|^▸\s/,'');
    });
  }
  bindAcc('accDaily');
  bindAcc('accWeekly');
  bindAcc('accEarly');

  // -----------------------------
  // Layer toggles
  // -----------------------------
  function bindLayerToggle(chkId, layer){
    const c = el(chkId);
    c.addEventListener('change', () => {
      if(c.checked) layer.addTo(map);
      else map.removeLayer(layer);
    });
  }
  bindLayerToggle('chkBorders', layerBorders);
  bindLayerToggle('chkHotspots', layerHotspots);
  bindLayerToggle('chkEarly', layerEarly);
  bindLayerToggle('chkGdelt', layerGdelt);
  bindLayerToggle('chkUsgs', layerUsgs);
  bindLayerToggle('chkGdacs', layerGdacs);

  // -----------------------------
  // Filtering (All vs Today)
  // -----------------------------
  let gdeltAllFeatures = null; // store full geojson
  let filterMode = 'all'; // 'all' | 'today'

  function applyGdeltFilter(){
    if(!gdeltAllFeatures) return;
    if(filterMode === 'all'){
      layerGdelt.clearLayers();
      layerGdelt.addData(gdeltAllFeatures);
      return;
    }
    // today in Budapest
    const todayKey = toBudapestDateKey(new Date());
    const filtered = {
      type: "FeatureCollection",
      features: (gdeltAllFeatures.features || []).filter(f => {
        const p = f.properties || {};
        const iso = p.time || p.seendate;
        if(!iso) return false;
        const k = toBudapestDateKey(new Date(iso));
        return k === todayKey;
      })
    };
    layerGdelt.clearLayers();
    layerGdelt.addData(filtered);
  }

  el('btnFilterAll').onclick = () => {
    filterMode = 'all';
    el('btnFilterAll').classList.add('active');
    el('btnFilterToday').classList.remove('active');
    applyGdeltFilter();
  };
  el('btnFilterToday').onclick = () => {
    filterMode = 'today';
    el('btnFilterToday').classList.add('active');
    el('btnFilterAll').classList.remove('active');
    applyGdeltFilter();
  };

  // -----------------------------
  // Alert bar
  // -----------------------------
  el('alertclose').onclick = () => el('alertbar').classList.remove('open');

  function setAlert(alertObj){
    if(!alertObj){ el('alertbar').classList.remove('open'); return; }
    const badge = el('alertbadge');
    const txt = el('alerttext');
    badge.textContent = (alertObj.title || 'RIASZTÁS').toUpperCase();
    txt.textContent = alertObj.text || '';
    const level = (alertObj.level || 'info').toLowerCase();
    let col = '#111827';
    if(level === 'high') col = 'var(--danger)';
    else if(level === 'medium') col = 'var(--warn)';
    else if(level === 'ok') col = 'var(--ok)';
    badge.style.borderColor = 'rgba(0,0,0,.12)';
    badge.style.background = 'rgba(0,0,0,.04)';
    badge.style.color = col;
    el('alertbar').classList.add('open');
  }

  // -----------------------------
  // Hotspot list
  // -----------------------------
  function renderHotspotList(top){
    const box = el('hotspotList');
    if(!top || !top.length){
      box.innerHTML = '<div class="muted">Nincs elég adat.</div>';
      return;
    }
    box.innerHTML = '';
    top.forEach((h, idx) => {
      const div = document.createElement('div');
      div.className = 'hsitem';
      const place = escapeHtml(h.place || 'ismeretlen térség');
      const arrow = escapeHtml(h.trend_arrow || '');
      const score = Number(h.score || 0).toFixed(2);
      const ch = (h.change_pct === null || h.change_pct === undefined) ? 'n/a' : `${Number(h.change_pct).toFixed(0)}%`;
      div.innerHTML = `
        <div class="t">${idx+1}. ${place} ${arrow}</div>
        <div class="m">
          <span>score: <b>${score}</b></span>
          <span>7 nap: <b>${ch}</b></span>
          <span class="muted">(${Number(h.lat).toFixed(2)}, ${Number(h.lon).toFixed(2)})</span>
        </div>
      `;
      div.onclick = () => {
        map.setView([h.lat, h.lon], 7, { animate:true });
      };
      box.appendChild(div);
    });
  }

  // -----------------------------
  // Load data
  // -----------------------------
  async function loadAll(){
    // meta
    try{
      const meta = await fetchJson('./data/meta.json');
      const counts = meta.counts || {};
      el('metaLine').textContent = `Frissítés: ${fmtLocalBudapest(meta.generated_utc || meta.generatedUtc)} | hotspot cellák: ${counts.hotspot_cells ?? '—'} | GDELT: ${counts.gdelt ?? '—'} | USGS: ${counts.usgs ?? '—'} | GDACS: ${counts.gdacs ?? '—'}`;
    }catch{ el('metaLine').textContent = '—'; }

    // borders
    try{
      const borders = await fetchJson('./data/cee_borders.geojson');
      layerBorders.clearLayers();
      layerBorders.addData(borders);
      // fit once if possible
      try{ map.fitBounds(layerBorders.getBounds(), { padding:[20,20] }); }catch{}
    }catch{}

    // gdelt
    try{
      const gdelt = await fetchJson('./data/gdelt.geojson');
      gdeltAllFeatures = gdelt;
      layerGdelt.clearLayers();
      layerGdelt.addData(gdelt);
      applyGdeltFilter(); // respect current filter
    }catch{
      gdeltAllFeatures = { type:'FeatureCollection', features:[] };
      layerGdelt.clearLayers();
    }

    // usgs
    try{
      const usgs = await fetchJson('./data/usgs.geojson');
      layerUsgs.clearLayers();
      layerUsgs.addData(usgs);
    }catch{ layerUsgs.clearLayers(); }

    // gdacs
    try{
      const gdacs = await fetchJson('./data/gdacs.geojson');
      layerGdacs.clearLayers();
      layerGdacs.addData(gdacs);
    }catch{ layerGdacs.clearLayers(); }

    // hotspots geo
    try{
      const hs = await fetchJson('./data/hotspots.geojson');
      layerHotspots.clearLayers();
      layerHotspots.addData(hs);
    }catch{ layerHotspots.clearLayers(); }

    // early geo
    try{
      const early = await fetchJson('./data/early.geojson');
      layerEarly.clearLayers();
      layerEarly.addData(early);
    }catch{ layerEarly.clearLayers(); }

    // hotspots top list
    try{
      const hsTop = await fetchJson('./data/hotspots.json');
      el('hsGen').textContent = hsTop.generated_utc ? fmtLocalBudapest(hsTop.generated_utc) : '—';
      renderHotspotList(hsTop.top || []);
    }catch{
      el('hsGen').textContent = '—';
      renderHotspotList([]);
    }

    // daily summary
    try{
      const sum = await fetchJson('./data/summary.json');
      el('dailyTime').textContent = sum.generated_utc ? fmtLocalBudapest(sum.generated_utc) : '—';
      const bullets = (sum.bullets || []).map(b => `<li>${escapeHtml(b)}</li>`).join('');
      el('dailyBullets').innerHTML = bullets ? `<ul>${bullets}</ul>` : '<span class="muted">Nincs adat.</span>';
      setAlert(sum.alert || null);
    }catch{
      el('dailyTime').textContent = '—';
      el('dailyBullets').textContent = 'Nincs adat.';
      setAlert(null);
    }

    // weekly summary
    try{
      const w = await fetchJson('./data/weekly.json');
      el('weeklyTime').textContent = w.generated_utc ? fmtLocalBudapest(w.generated_utc) : '—';
      const bullets = (w.bullets || []).map(b => `<li>${escapeHtml(b)}</li>`).join('');
      el('weeklyBullets').innerHTML = bullets ? `<ul>${bullets}</ul>` : '<span class="muted">Nincs adat.</span>';
    }catch{
      el('weeklyTime').textContent = '—';
      el('weeklyBullets').textContent = 'Nincs adat.';
    }

    // early “time” just mirror meta if present
    try{
      const e = await fetchJson('./data/early.json');
      el('earlyTime').textContent = e.generated_utc ? fmtLocalBudapest(e.generated_utc) : '—';
    }catch{ el('earlyTime').textContent = '—'; }
  }

  // Default: ALL PANELS CLOSED (requested)
  show('panelSummary', false);
  show('panelLayers', false);
  show('panelHotspots', false);
  show('panelLegend', false);

  // But keep alertbar visible if there is an alert (loaded from summary.json)
  // (we open it when load finishes)

  loadAll();
})();
</script>
</body>
</html>
