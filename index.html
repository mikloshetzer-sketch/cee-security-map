<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>K√∂z√©p‚ÄìKelet Eur√≥pa Biztons√°gi Monitor ‚Äì t√©rk√©p</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100vh; width: 100vw; }

    .panel {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: rgba(255,255,255,0.92);
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
      padding: 12px 12px 10px 12px;
      max-width: 380px;
      line-height: 1.25;
    }
    .panel h3 { margin: 0 0 6px 0; font-size: 16px; }
    .panel h4 { margin: 10px 0 6px 0; font-size: 14px; }
    .panel .small { font-size: 12px; color: #333; opacity: 0.85; }
    .panel ul { margin: 6px 0 8px 18px; padding: 0; }
    .panel li { margin: 4px 0; font-size: 13px; }

    .panel-header {
      display:flex; align-items:center; justify-content:space-between;
      gap: 8px;
      margin-bottom: 6px;
    }
    .btn {
      cursor:pointer;
      border: 1px solid rgba(0,0,0,0.15);
      background: rgba(255,255,255,0.95);
      border-radius: 8px;
      padding: 6px 10px;
      font-size: 12px;
    }
    .btn:hover { background: white; }

    .floating-open {
      position: absolute;
      z-index: 999;
      left: 10px;
      top: 10px;
      display:flex;
      flex-direction:column;
      gap: 8px;
    }

    .badge {
      display:inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid rgba(0,0,0,0.15);
      background: rgba(255,255,255,0.9);
    }

    .legend {
      background: rgba(255,255,255,0.92);
      padding: 10px;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-size: 12px;
      line-height: 1.2;
    }
    .legend .row { display:flex; align-items:center; gap:8px; margin: 4px 0; }
    .dot {
      width: 10px; height: 10px; border-radius: 50%;
      border: 1px solid rgba(0,0,0,0.25);
      display:inline-block;
    }

    .popup-title { font-weight: 700; margin-bottom: 4px; }
    .popup-line { margin: 2px 0; font-size: 12px; }
    .popup-links a { font-size: 12px; }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- ‚ÄúKinyit‚Äù gombok, ha a panelek be vannak z√°rva -->
  <div class="floating-open" id="openButtons" style="display:none;">
    <button class="btn" id="openSummaryBtn">Kinyit: Kivonatok</button>
    <button class="btn" id="openLayersBtn">Kinyit: R√©tegek</button>
    <button class="btn" id="openHotspotsBtn">Kinyit: Top hotspotok</button>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const DATA = "data";

    // ---- Category palette (nem √°ll√≠tunk konkr√©t sz√≠neket t√∫l szigor√∫an, de legyen konzisztens)
    const CAT_STYLE = {
      protest:        { radius: 6, fillOpacity: 0.55 },
      border:         { radius: 6, fillOpacity: 0.55 },
      police:         { radius: 6, fillOpacity: 0.55 },
      military:       { radius: 6, fillOpacity: 0.55 },
      drone:          { radius: 6, fillOpacity: 0.55 },
      cyber:          { radius: 6, fillOpacity: 0.55 },
      energy:         { radius: 6, fillOpacity: 0.55 },
      infrastructure: { radius: 6, fillOpacity: 0.55 },
      security_politics:{ radius: 6, fillOpacity: 0.55 },
      violence:       { radius: 7, fillOpacity: 0.60 },
      natural:        { radius: 6, fillOpacity: 0.50 },
      other:          { radius: 6, fillOpacity: 0.45 }
    };

    function humanCat(cat){
      const m = {
        protest: "t√ºntet√©s/er≈ëszak",
        border: "hat√°r/migr√°ci√≥",
        police: "rend≈ërs√©g/jog",
        military: "katonai",
        drone: "dr√≥n/UAV",
        cyber: "kiber/dezinform√°ci√≥",
        energy: "energia/ell√°t√°s",
        infrastructure: "infrastrukt√∫ra",
        security_politics: "security politics",
        violence: "er≈ëszak",
        natural: "term√©szeti",
        other: "egy√©b"
      };
      return m[cat] || cat || "egy√©b";
    }

    function fmtTime(t){
      if(!t) return "‚Äî";
      try {
        const d = new Date(t);
        if(isNaN(d.getTime())) return t;
        return d.toISOString().replace("T"," ").replace(".000Z","Z");
      } catch { return t; }
    }

    function escapeHtml(s){
      return String(s||"").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    // ---- Leaflet base
    const map = L.map("map", { preferCanvas: true }).setView([48.6, 19.3], 5);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // ---- Layers
    const layerBorders = L.geoJSON(null, { style: { weight: 2 } });
    const layerUSGS = L.geoJSON(null, { pointToLayer: (f, latlng) => circleForFeature(f, latlng, "USGS") });
    const layerGDACS = L.geoJSON(null, { pointToLayer: (f, latlng) => circleForFeature(f, latlng, "GDACS") });

    // GEO jelz√©sek (sok pont, link nem mindig)
    const layerGDELT = L.geoJSON(null, { pointToLayer: (f, latlng) => circleForFeature(f, latlng, "GDELT") });

    // LINKES esem√©nyek (export) ‚Äì itt MINDIG van sources lista (ha tal√°lt)
    const layerGDELTLinked = L.geoJSON(null, { pointToLayer: (f, latlng) => circleForFeature(f, latlng, "GDELT_LINKED") });

    const layerHotspots = L.geoJSON(null, { pointToLayer: (f, latlng) => hotspotMarker(f, latlng) });
    const layerEarly = L.geoJSON(null, { pointToLayer: (f, latlng) => earlyMarker(f, latlng) });

    function circleForFeature(feature, latlng, src){
      const p = feature.properties || {};
      const cat = p.category || "other";
      const st = CAT_STYLE[cat] || CAT_STYLE.other;

      // sz√≠n n√©lk√ºl nem t√∫l informat√≠v, de legyen minim√°lisan megk√ºl√∂nb√∂ztethet≈ë:
      // (Leaflet default k√©k k√∂rvonal). A fillColor-t nem fix√°ljuk "sz√≠nk√≥d t√°bl√°val",
      // de enyhe k√ºl√∂nbs√©g kell -> egyszer≈± map:
      const fillColor = (cat === "cyber") ? "#6f42c1" :
                        (cat === "energy") ? "#d39e00" :
                        (cat === "border") ? "#0c8599" :
                        (cat === "protest") ? "#c92a2a" :
                        (cat === "military") ? "#2f9e44" :
                        (cat === "drone") ? "#364fc7" :
                        (cat === "police") ? "#343a40" :
                        (cat === "security_politics") ? "#5c7cfa" :
                        (cat === "natural") ? "#099268" :
                        (cat === "violence") ? "#a61e4d" : "#868e96";

      const m = L.circleMarker(latlng, {
        radius: st.radius,
        weight: 1,
        fillOpacity: st.fillOpacity,
        fillColor,
      });

      const html = popupHtmlFor(feature);
      m.bindPopup(html, { maxWidth: 420 });
      return m;
    }

    function popupHtmlFor(feature){
      const p = feature.properties || {};
      const title = p.title || p.location || p.place || "Esem√©ny";
      const when = fmtTime(p.time || p.date);
      const src = p.source || "‚Äî";
      const cat = humanCat(p.category || p.gdelt_bucket || "other");

      // Link logika:
      // 1) linked r√©teg: p.sources[] / p.url
      // 2) geo r√©teg: p.url (ha van) vagy p.search_url (mindig van)
      let linksHtml = "";
      const links = [];

      if (Array.isArray(p.sources) && p.sources.length) {
        for (const u of p.sources.slice(0, 6)) links.push({ label: "Forr√°s", url: u });
      } else if (p.url) {
        links.push({ label: "Forr√°s", url: p.url });
      } else if (p.search_url) {
        links.push({ label: "GDELT keres√©s", url: p.search_url });
      }

      if (links.length) {
        linksHtml = `<div class="popup-links">` +
          links.map((x,i)=>`<div class="popup-line">üîó <a href="${escapeHtml(x.url)}" target="_blank" rel="noopener">${escapeHtml(x.label)} ${links.length>1?('#'+(i+1)):""}</a></div>`).join("") +
          `</div>`;
      } else {
        linksHtml = `<div class="popup-line">Nincs link az adatban.</div>`;
      }

      const extra = [];
      if (p.domain) extra.push(`Domain: ${escapeHtml(p.domain)}`);
      if (p.mag) extra.push(`M: ${escapeHtml(p.mag)}`);
      if (p.event_root_code) extra.push(`Root: ${escapeHtml(p.event_root_code)}`);
      if (p.event_codes && Array.isArray(p.event_codes) && p.event_codes.length) extra.push(`K√≥dok: ${escapeHtml(p.event_codes.join(", "))}`);

      return `
        <div class="popup-title">${escapeHtml(title)}</div>
        <div class="popup-line"><b>Kateg√≥ria:</b> ${escapeHtml(cat)}</div>
        <div class="popup-line"><b>Id≈ë:</b> ${escapeHtml(when)}</div>
        <div class="popup-line"><b>Forr√°s:</b> ${escapeHtml(src)}</div>
        ${extra.length ? `<div class="popup-line">${extra.join(" | ")}</div>` : ``}
        ${linksHtml}
      `;
    }

    function hotspotMarker(feature, latlng){
      const p = feature.properties || {};
      const score = (p.score != null) ? Number(p.score) : 0;
      const r = Math.max(6, Math.min(18, 6 + score * 6));

      const m = L.circleMarker(latlng, {
        radius: r,
        weight: 2,
        fillOpacity: 0.15,
      });

      const sources = p.sources ? JSON.stringify(p.sources) : "";
      m.bindPopup(`
        <div class="popup-title">Hotspot r√°cspont</div>
        <div class="popup-line"><b>Score:</b> ${escapeHtml(p.score)}</div>
        <div class="popup-line"><b>Trend:</b> ${escapeHtml(p.trend_arrow || "")} ${escapeHtml(p.trend || "")}</div>
        <div class="popup-line"><b>Forr√°smix:</b> ${escapeHtml(sources)}</div>
      `);
      return m;
    }

    function earlyMarker(feature, latlng){
      const p = feature.properties || {};
      const e = (p.escalation != null) ? Number(p.escalation) : 0;
      const r = Math.max(6, Math.min(16, 6 + e / 12));

      const m = L.circleMarker(latlng, {
        radius: r,
        weight: 2,
        fillOpacity: 0.10,
      });

      m.bindPopup(`
        <div class="popup-title">Early signal</div>
        <div class="popup-line"><b>Escalation:</b> ${escapeHtml(p.escalation)}</div>
        <div class="popup-line"><b>Recent:</b> ${escapeHtml(p.recent)} | <b>Baseline:</b> ${escapeHtml(p.baseline)}</div>
        <div class="popup-line"><b>Zone:</b> ${escapeHtml(p.zone || "‚Äî")} (x${escapeHtml(p.zone_mult)})</div>
      `);
      return m;
    }

    // ---- Controls: layers (we‚Äôll put into a closable panel)
    let layersControl = null;

    // ---- Panels
    let summaryControl, hotspotsControl, layersPanelControl;

    function makePanelControl(position, id, title, innerHtml, onClose){
      const C = L.Control.extend({
        onAdd: function(){
          const div = L.DomUtil.create("div", "panel");
          div.id = id;

          div.innerHTML = `
            <div class="panel-header">
              <h3>${escapeHtml(title)}</h3>
              <button class="btn" data-close="1">Bez√°r</button>
            </div>
            <div class="panel-body">${innerHtml}</div>
          `;

          L.DomEvent.disableClickPropagation(div);
          L.DomEvent.disableScrollPropagation(div);

          const btn = div.querySelector('button[data-close="1"]');
          btn.addEventListener("click", () => {
            map.removeControl(Ctrl);
            if (onClose) onClose();
            refreshOpenButtons();
          });

          return div;
        }
      });
      const Ctrl = new C({ position });
      return Ctrl;
    }

    function refreshOpenButtons(){
      const openButtons = document.getElementById("openButtons");
      const need = (!summaryControlOnMap || !layersPanelOnMap || !hotspotsControlOnMap);
      openButtons.style.display = need ? "flex" : "none";
      document.getElementById("openSummaryBtn").style.display = summaryControlOnMap ? "none" : "block";
      document.getElementById("openLayersBtn").style.display = layersPanelOnMap ? "none" : "block";
      document.getElementById("openHotspotsBtn").style.display = hotspotsControlOnMap ? "none" : "block";
    }

    let summaryControlOnMap = true;
    let hotspotsControlOnMap = true;
    let layersPanelOnMap = true;

    document.getElementById("openSummaryBtn").addEventListener("click", () => {
      if (!summaryControlOnMap) { map.addControl(summaryControl); summaryControlOnMap = true; refreshOpenButtons(); }
    });
    document.getElementById("openLayersBtn").addEventListener("click", () => {
      if (!layersPanelOnMap) { map.addControl(layersPanelControl); layersPanelOnMap = true; refreshOpenButtons(); }
    });
    document.getElementById("openHotspotsBtn").addEventListener("click", () => {
      if (!hotspotsControlOnMap) { map.addControl(hotspotsControl); hotspotsControlOnMap = true; refreshOpenButtons(); }
    });

    // ---- Legend
    const legend = L.control({ position: "bottomright" });
    legend.onAdd = function(){
      const div = L.DomUtil.create("div", "legend");
      div.innerHTML = `
        <div style="font-weight:700;margin-bottom:6px;">Kateg√≥ri√°k</div>
        ${[
          ["protest","T√ºntet√©s/er≈ëszak"],
          ["border","Hat√°r/migr√°ci√≥"],
          ["police","Rend≈ërs√©g/jog"],
          ["military","Katonai"],
          ["drone","Dr√≥n/UAV"],
          ["cyber","Kiber/dezinform√°ci√≥"],
          ["energy","Energia/ell√°t√°s"],
          ["infrastructure","Infrastrukt√∫ra"],
          ["security_politics","Security politics"],
          ["natural","Term√©szeti"],
          ["other","Egy√©b"],
        ].map(([k,label]) => {
          const fill = (k === "cyber") ? "#6f42c1" :
                       (k === "energy") ? "#d39e00" :
                       (k === "border") ? "#0c8599" :
                       (k === "protest") ? "#c92a2a" :
                       (k === "military") ? "#2f9e44" :
                       (k === "drone") ? "#364fc7" :
                       (k === "police") ? "#343a40" :
                       (k === "security_politics") ? "#5c7cfa" :
                       (k === "natural") ? "#099268" :
                       (k === "violence") ? "#a61e4d" : "#868e96";
          return `<div class="row"><span class="dot" style="background:${fill}"></span><span>${label}</span></div>`;
        }).join("")}
        <div style="margin-top:8px;" class="small">Megjegyz√©s: GDELT GEO jelz√©sekben nem mindig van cikk-link; ilyenkor ‚ÄúGDELT keres√©s‚Äù linket adunk.</div>
      `;
      L.DomEvent.disableClickPropagation(div);
      return div;
    };
    legend.addTo(map);

    // ============================================================
    // Load all data
    // ============================================================
    async function loadJson(path){
      const r = await fetch(path, { cache: "no-store" });
      if(!r.ok) throw new Error(`Fetch failed: ${path} (${r.status})`);
      return await r.json();
    }

    async function init(){
      // load meta + summaries
      let meta = null, daily = null, weekly = null, hotspotsTop = null, earlyTop = null;
      try { meta = await loadJson(`${DATA}/meta.json`); } catch {}
      try { daily = await loadJson(`${DATA}/summary.json`); } catch {}
      try { weekly = await loadJson(`${DATA}/weekly.json`); } catch {}
      try { hotspotsTop = await loadJson(`${DATA}/hotspots.json`); } catch {}
      try { earlyTop = await loadJson(`${DATA}/early.json`); } catch {}

      // Summary panel HTML
      const gen = (meta && meta.generated_utc) ? meta.generated_utc : (daily && daily.generated_utc) ? daily.generated_utc : "";
      const counts = meta && meta.counts ? meta.counts : null;

      const dailyBullets = daily && daily.bullets ? daily.bullets : ["‚Äî"];
      const weeklyBullets = weekly && weekly.bullets ? weekly.bullets : ["‚Äî"];

      const headerLine = `
        <div class="small">
          Friss√≠t√©s: <b>${escapeHtml(gen || "‚Äî")}</b> |
          ${counts ? `hotspot cell√°k: <b>${counts.hotspot_cells||0}</b> | GDELT: <b>${counts.gdelt||0}</b> + linkes: <b>${counts.gdelt_linked||0}</b> | USGS: <b>${counts.usgs||0}</b> | GDACS: <b>${counts.gdacs||0}</b>` : ""}
        </div>
      `;

      const summaryHtml = `
        ${headerLine}
        <h4>${escapeHtml(daily ? daily.headline : "Napi kivonat")}</h4>
        <ul>${dailyBullets.map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul>

        <h4>${escapeHtml(weekly ? weekly.headline : "Heti kivonat")}</h4>
        <ul>${weeklyBullets.map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul>

        <h4>Early signals (elemz≈ë m√≥d)</h4>
        <div class="small">A r√©teg bekapcsolhat√≥ a ‚ÄúEARLY‚Äù jel√∂l√©ssel.</div>
      `;

      summaryControl = makePanelControl("topleft", "panelSummary", "K√∂z√©p‚ÄìKelet Eur√≥pa Biztons√°gi Monitor ‚Äì helyzetk√©p", summaryHtml, () => {
        summaryControlOnMap = false;
      });
      map.addControl(summaryControl);

      // Hotspots panel
      const top = hotspotsTop && hotspotsTop.top ? hotspotsTop.top : [];
      const hsHtml = top.length ? `
        <div class="small">Kattints a sorra ‚Üí zoom a r√°cspontra.</div>
        <div style="margin-top:6px; display:flex; flex-direction:column; gap:6px;">
          ${top.slice(0,8).map((h,i)=>{
            const place = h.place || "unknown";
            const s = (h.score!=null)? Number(h.score).toFixed(2) : "‚Äî";
            const arrow = h.trend_arrow || "";
            return `<button class="btn" data-hs="${i}" style="text-align:left;">
              <b>${escapeHtml(place)}</b> ${escapeHtml(arrow)}<br/>
              <span class="small">(${h.lat.toFixed(2)}, ${h.lon.toFixed(2)}) ¬∑ score: ${escapeHtml(s)}</span>
            </button>`;
          }).join("")}
        </div>
      ` : `<div class="small">Nincs el√©g adat.</div>`;

      hotspotsControl = makePanelControl("bottomleft", "panelHotspots", "Top hotspotok", hsHtml, () => {
        hotspotsControlOnMap = false;
      });
      map.addControl(hotspotsControl);

      // attach hotspot click handlers
      setTimeout(()=>{
        const root = document.getElementById("panelHotspots");
        if(!root || !top.length) return;
        root.querySelectorAll("button[data-hs]").forEach(btn=>{
          btn.addEventListener("click", ()=>{
            const idx = Number(btn.getAttribute("data-hs"));
            const h = top[idx];
            if(!h) return;
            map.setView([h.lat, h.lon], 7);
          });
        });
      }, 0);

      // Layers panel (custom so it can be reopened)
      layersPanelControl = makePanelControl("topright", "panelLayers", "R√©tegek", `<div id="layersMount"></div>`, () => {
        layersPanelOnMap = false;
      });
      map.addControl(layersPanelControl);

      // now create real layers control into mount node
      setTimeout(()=>{
        const mount = document.getElementById("layersMount");
        if(!mount) return;

        const baseLayers = {};
        const overlays = {
          "HAT√ÅR (kont√∫r)": layerBorders,
          "GDELT (h√≠rek) ‚Äì GEO jelz√©sek": layerGDELT,
          "GDELT (h√≠rek) ‚Äì LINKES esem√©nyek": layerGDELTLinked,
          "USGS (reng√©sek)": layerUSGS,
          "GDACS (riaszt√°s)": layerGDACS,
          "HOTSPOT (heat)": layerHotspots,
          "EARLY (elemz≈ë)": layerEarly,
        };

        layersControl = L.control.layers(baseLayers, overlays, { collapsed: false });
        layersControl.addTo(map);

        // move Leaflet's control DOM into our panel
        const lcEl = document.querySelector(".leaflet-control-layers");
        if (lcEl) {
          lcEl.style.boxShadow = "none";
          lcEl.style.background = "transparent";
          lcEl.style.padding = "0";
          mount.appendChild(lcEl);
        }
      }, 0);

      // Load geojson layers
      const [borders, gdelt, gdeltLinked, usgs, gdacs, hotspots, early] = await Promise.all([
        loadJson(`${DATA}/cee_borders.geojson`).catch(()=>null),
        loadJson(`${DATA}/gdelt.geojson`).catch(()=>null),
        loadJson(`${DATA}/gdelt_linked.geojson`).catch(()=>null),
        loadJson(`${DATA}/usgs.geojson`).catch(()=>null),
        loadJson(`${DATA}/gdacs.geojson`).catch(()=>null),
        loadJson(`${DATA}/hotspots.geojson`).catch(()=>null),
        loadJson(`${DATA}/early.geojson`).catch(()=>null),
      ]);

      if (borders) layerBorders.addData(borders);
      if (gdelt) layerGDELT.addData(gdelt);
      if (gdeltLinked) layerGDELTLinked.addData(gdeltLinked);
      if (usgs) layerUSGS.addData(usgs);
      if (gdacs) layerGDACS.addData(gdacs);
      if (hotspots) layerHotspots.addData(hotspots);
      if (early) layerEarly.addData(early);

      // Default visible layers:
      layerBorders.addTo(map);
      layerGDELT.addTo(map);
      // linked r√©teg alapb√≥l OFF (nehogy ‚Äûtele legyen‚Äù), de bekapcsolhat√≥:
      // layerGDELTLinked.addTo(map);

      refreshOpenButtons();
    }

    init().catch(err=>{
      console.error(err);
      alert("Hiba a bet√∂lt√©sben: " + err.message);
    });
  </script>
</body>
</html>
